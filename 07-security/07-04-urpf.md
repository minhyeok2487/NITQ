# 07-04. uRPF (Unicast Reverse Path Forwarding)

---

## 면접관: "고객사의 ISP 연결 구간에서 Source IP가 위조된 패킷, 즉 IP Spoofing 공격이 탐지되고 있습니다. DDoS 공격 트래픽인데, 출발지 IP가 매번 다르게 위조되어 있어서 ACL로 차단하기가 어렵다고 해요. 네트워크 장비 레벨에서 할 수 있는 대응 방법을 제안해주세요."

IP Spoofing 대응에는 **uRPF(Unicast Reverse Path Forwarding)** 를 적용하겠습니다. uRPF는 패킷의 Source IP가 실제로 해당 인터페이스로 도달할 수 있는 유효한 경로인지를 라우팅 테이블(RIB/FIB)로 역방향 검증하는 기능입니다.

핵심 원리는 간단합니다. "이 인터페이스로 들어온 패킷의 Source IP로 돌아가려면, 같은 인터페이스로 나가야 정상이다"라는 논리입니다. 이것이 맞지 않으면 위조된 패킷으로 판단하고 Drop합니다.

**설계 포인트:**
- **적용 위치**: ISP 연결 인터페이스 (Ingress 방향)
- **모드**: 네트워크 토폴로지에 따라 Strict 또는 Loose 선택
- **주의**: 비대칭 라우팅(Asymmetric Routing) 환경에서 Strict 모드 적용 시 정상 트래픽 차단 가능

> 토폴로지 이미지 추가 예정

### 핵심 설정

```
! ==== 단일 ISP 연결 (Single-Homed) - Strict Mode ====
!
interface GigabitEthernet0/0
 description TO-ISP-A
 ip address 203.0.113.2 255.255.255.252
 ip verify unicast source reachable-via rx
 ! rx = Strict Mode (수신 인터페이스로 역방향 경로 확인)
!
! ==== 멀티 ISP 연결 (Multi-Homed) - Loose Mode ====
!
interface GigabitEthernet0/0
 description TO-ISP-A
 ip address 203.0.113.2 255.255.255.252
 ip verify unicast source reachable-via any
 ! any = Loose Mode (어떤 인터페이스든 경로만 있으면 통과)
!
interface GigabitEthernet0/1
 description TO-ISP-B
 ip address 198.51.100.2 255.255.255.252
 ip verify unicast source reachable-via any
!
! ==== uRPF 통계 확인 ====
show ip verify source
show ip interface GigabitEthernet0/0 | include verify
show cef interface GigabitEthernet0/0
!
! Drop된 패킷 카운터
show ip traffic | include RPF
```

---

## 면접관: "Strict Mode와 Loose Mode의 차이를 자세히 설명해주세요. 각각 어떤 환경에 적합한가요?"

uRPF의 두 모드는 검증 기준이 다릅니다.

### Strict Mode (`reachable-via rx`)

패킷이 들어온 인터페이스를 통해 Source IP로의 역방향 경로가 존재하는지 확인합니다. 즉, **인터페이스까지 일치**해야 합니다.

```
패킷 수신: Gi0/0으로 Source IP 10.1.1.1인 패킷 도착
                    ↓
FIB 조회: 10.1.1.1로 가려면 어떤 인터페이스로 나가야 하나?
                    ↓
       결과: Gi0/0으로 나감 → 같은 인터페이스 → 통과 ✓
       결과: Gi0/1으로 나감 → 다른 인터페이스 → Drop ✗
       결과: 경로 없음 → Drop ✗
```

**적합 환경:**
- Single-Homed (ISP 1개)
- 대칭 라우팅이 보장되는 환경
- Stub 네트워크, 고객 접속 구간
- 가장 강력한 Spoofing 방어

### Loose Mode (`reachable-via any`)

Source IP로의 경로가 라우팅 테이블에 **존재하기만 하면** 통과합니다. 어떤 인터페이스인지는 상관없습니다.

```
패킷 수신: Gi0/0으로 Source IP 10.1.1.1인 패킷 도착
                    ↓
FIB 조회: 10.1.1.1로 가는 경로가 있는가?
                    ↓
       결과: 경로 있음 (어떤 인터페이스든) → 통과 ✓
       결과: 경로 없음 (Default Route만 있으면?) → 주의 필요
       결과: 완전히 경로 없음 → Drop ✗
```

**적합 환경:**
- Multi-Homed (ISP 2개 이상)
- 비대칭 라우팅이 존재하는 환경
- BGP Full Route를 수신하는 환경
- Strict보다 약하지만, 존재하지 않는 IP(예: Bogon IP)로의 Spoofing은 차단 가능

```
! 비교 정리
!
! [Single-Homed]
! Customer ──── ISP
!   Gi0/0 (Strict OK: 경로가 하나뿐이므로 대칭 보장)
!
! [Multi-Homed / Asymmetric]
! Customer ──── ISP-A
!          └─── ISP-B
!   ISP-A에서 들어온 패킷의 return path가 ISP-B일 수 있음
!   → Strict 적용 시 정상 트래픽 Drop
!   → Loose 적용해야 함
```

---

## 면접관: "그런데 uRPF Strict Mode를 적용했더니 정상 트래픽도 차단되고 있다고 합니다. 비대칭 라우팅 때문인 것 같은데, 어떻게 확인하고 해결하시겠어요?"

비대칭 라우팅 환경에서 Strict uRPF를 적용하면 발생하는 전형적인 문제입니다. 단계별로 대응하겠습니다.

**1단계: uRPF Drop 확인**

```
! uRPF에 의해 Drop된 패킷 카운터 확인
show ip traffic | include RPF
!
! 출력 예시:
! 0 no route, 1523 unicast RPF, 0 forced drop
!                ^^^^
!         이 카운터가 계속 증가하면 uRPF Drop 발생 중

! 인터페이스별 uRPF 상태
show ip interface GigabitEthernet0/0 | include verify
!
! 출력: IP verify source reachable-via RX

! CEF에서 상세 확인
show cef interface GigabitEthernet0/0 internal
```

**2단계: 비대칭 라우팅 확인**

```
! 문제되는 Source IP에 대한 라우팅 경로 확인
show ip route 10.1.1.1
show ip cef 10.1.1.1 detail
!
! 출력 예시:
! 10.1.1.0/24 is known via BGP
!   via 198.51.100.1, GigabitEthernet0/1  ← ISP-B 방향
!
! 하지만 패킷은 GigabitEthernet0/0 (ISP-A)로 들어옴
! → 수신 인터페이스 ≠ 역방향 경로 인터페이스
! → Strict Mode에서 Drop됨
!
! Traceroute로 비대칭 경로 확인
traceroute 10.1.1.1 source GigabitEthernet0/0
traceroute 10.1.1.1 source GigabitEthernet0/1
```

**3단계: 해결 방안**

해결책은 세 가지가 있으며, 환경에 따라 선택합니다.

**방법 1: Loose Mode로 변경 (가장 현실적)**

```
interface GigabitEthernet0/0
 no ip verify unicast source reachable-via rx
 ip verify unicast source reachable-via any
```

**방법 2: Strict Mode + ACL 예외 허용 (`allow-default`)**

특정 Source IP 대역에 대해 uRPF 검사를 예외 처리합니다.

```
! ACL로 예외 대상 정의
ip access-list extended URPF-EXCEPTION
 permit ip 10.1.1.0 0.0.0.255 any        ! 비대칭 경로 대역 허용
 permit ip 172.16.0.0 0.15.255.255 any    ! 추가 예외
 deny   ip any any                        ! 나머지는 uRPF 검사 적용
!
interface GigabitEthernet0/0
 ip verify unicast source reachable-via rx allow-default 100
 ! allow-default: Default Route(0.0.0.0/0)도 유효 경로로 인정
 ! 100: ACL 번호 (permit된 Source IP는 uRPF 검사 통과)
```

`allow-default` 옵션은 Default Route가 있으면 모든 Source IP가 통과할 수 있어 Strict의 의미가 약해집니다. ACL과 함께 사용해서 Bogon IP(RFC 1918, RFC 5737 등)만 명시적으로 차단하는 방식이 현실적입니다.

**방법 3: Feasible-Path uRPF (일부 플랫폼 지원)**

```
! Feasible-Path: RIB의 Best Path뿐 아니라
! 모든 유효 경로(Alternative Path)를 검사
! BGP에서 Best Path가 아닌 경로도 유효하면 통과 허용
!
interface GigabitEthernet0/0
 ip verify unicast source reachable-via rx allow-self-ping
 ! 일부 Nexus/XR 플랫폼에서 지원
```

---

## 면접관: "BGP를 사용하는 ISP 환경에서 uRPF를 적용할 때 특별히 주의해야 할 점이 있나요?"

BGP 환경에서 uRPF 적용은 여러 함정이 있습니다.

**1. BGP Best Path와 비대칭 라우팅**

BGP는 AS-Path, Local Preference, MED 등 다양한 속성으로 Best Path를 결정합니다. 상대방 ISP도 자체 정책으로 Best Path를 결정하므로, 양방향 경로가 다른 비대칭 라우팅이 매우 흔합니다.

```
! 예시: 고객이 ISP-A, ISP-B와 BGP 피어링
!
! 고객 → 8.8.8.8: ISP-A로 전송 (Best Path)
! 8.8.8.8 → 고객: ISP-B로 응답 (상대방 ISP의 Best Path)
!
! ISP-B 인터페이스에 Strict uRPF를 적용하면:
! Source IP 8.8.8.8의 역방향 경로가 ISP-A이므로 Drop됨
```

**결론: BGP Multi-Homed 환경에서는 Strict Mode를 ISP 인터페이스에 적용하면 안 됩니다.** Loose Mode를 사용해야 합니다.

**2. Default Route Only 수신 환경에서의 Loose Mode 함정**

```
! ISP로부터 Default Route만 수신하는 경우
ip route 0.0.0.0 0.0.0.0 203.0.113.1
!
! Loose Mode 적용 시:
! → 모든 Source IP가 Default Route로 매칭되어 통과
! → uRPF가 사실상 무의미해짐!
!
! 해결: Bogon IP 차단 ACL과 함께 사용
ip access-list extended BOGON-FILTER
 deny   ip 0.0.0.0 0.255.255.255 any           ! 0.0.0.0/8
 deny   ip 10.0.0.0 0.255.255.255 any          ! RFC1918
 deny   ip 127.0.0.0 0.255.255.255 any         ! Loopback
 deny   ip 169.254.0.0 0.0.255.255 any         ! Link-local
 deny   ip 172.16.0.0 0.15.255.255 any         ! RFC1918
 deny   ip 192.0.2.0 0.0.0.255 any             ! TEST-NET-1
 deny   ip 192.168.0.0 0.0.255.255 any         ! RFC1918
 deny   ip 198.51.100.0 0.0.0.255 any          ! TEST-NET-2
 deny   ip 203.0.113.0 0.0.0.255 any           ! TEST-NET-3
 deny   ip 224.0.0.0 15.255.255.255 any        ! Multicast
 deny   ip 240.0.0.0 15.255.255.255 any        ! Reserved
 permit ip any any
!
interface GigabitEthernet0/0
 ip verify unicast source reachable-via any allow-default
 ip access-group BOGON-FILTER in
```

**3. BGP Full Route 수신 시의 장점**

ISP에서 Full Route(약 100만+ 경로)를 수신하면, 전 세계의 유효한 IP 대역이 모두 라우팅 테이블에 존재합니다. 이 환경에서 Loose Mode uRPF는 매우 효과적입니다. 라우팅 테이블에 없는 Source IP = 존재하지 않는 IP = 거의 확실히 Spoofed IP이기 때문입니다.

```
! Full Route 수신 환경에서 Loose uRPF 적용
interface GigabitEthernet0/0
 ip verify unicast source reachable-via any
 ! Default Route 없이 Full Route만 있으면
 ! 유효하지 않은 IP 대역이 자동 차단됨
 ! → 별도 Bogon ACL 불필요
```

---

## 면접관: "uRPF 외에 IP Spoofing을 방어할 수 있는 다른 방법은 없나요?"

uRPF와 함께 사용하거나 대안으로 쓸 수 있는 방법들이 있습니다.

**1. IP Source Guard (L2 스위치)**

DHCP Snooping 테이블을 기반으로 Source IP와 MAC의 바인딩을 검증합니다. 액세스 스위치에서 동작하며, 사용자 포트 레벨에서 Spoofing을 방어합니다.

```
! DHCP Snooping 활성화
ip dhcp snooping
ip dhcp snooping vlan 100,200
!
! Trunk/Uplink는 Trust
interface GigabitEthernet1/0/48
 ip dhcp snooping trust
!
! 사용자 포트에 IP Source Guard 적용
interface GigabitEthernet1/0/1
 ip verify source                    ! IP만 검증
 ip verify source port-security      ! IP + MAC 둘 다 검증
!
show ip verify source
show ip dhcp snooping binding
```

**2. ACL 기반 Ingress Filtering (BCP38/RFC 2827)**

ISP가 고객 대역만 허용하는 Ingress ACL을 적용합니다.

```
! ISP 라우터에서 고객 인터페이스에 적용
! 고객에게 할당한 대역: 203.0.113.0/24
ip access-list extended CUSTOMER-INGRESS
 permit ip 203.0.113.0 0.0.0.255 any    ! 할당 대역만 허용
 deny   ip any any log                  ! 그 외 Source IP 차단
!
interface GigabitEthernet0/0
 description TO-CUSTOMER
 ip access-group CUSTOMER-INGRESS in
```

**3. TCP SYN Cookie (서버/로드밸런서)**

네트워크 장비가 아닌 서버/LB 레벨에서 SYN Flood를 방어합니다. uRPF와는 레이어가 다르지만 Spoofed IP를 이용한 SYN Flood 대응에 효과적입니다.

**실무 권장 조합:**

```
[ISP Edge]        → uRPF Loose + Bogon ACL (Spoofed Source IP 차단)
[고객 Edge]       → uRPF Strict 또는 ACL Ingress Filter
[Distribution]    → uRPF Strict (내부 VLAN 간)
[Access Switch]   → IP Source Guard + DHCP Snooping (사용자 레벨)
```

계층별로 다중 방어(Defense-in-Depth)를 적용하면, 한 계층에서 놓치더라도 다른 계층에서 잡을 수 있습니다.

---

## 면접관: "마지막으로, uRPF를 적용할 때 성능 영향은 없나요? 그리고 적용 전 사전 검증은 어떻게 하시겠어요?"

**성능 영향:**

uRPF는 CEF(Cisco Express Forwarding)의 FIB(Forwarding Information Base)를 활용하여 Hardware 레벨에서 동작합니다. 별도의 소프트웨어 처리가 아니라 기존 CEF Lookup에 역방향 조회를 추가하는 것이므로, **성능 영향은 거의 없습니다.** 다만 CEF가 반드시 활성화되어 있어야 합니다.

```
! CEF 활성화 확인 (필수 전제조건)
show ip cef
show cef interface GigabitEthernet0/0
!
! CEF가 비활성화되어 있으면 uRPF 자체가 동작하지 않음
ip cef                    ! 글로벌 CEF 활성화
```

**사전 검증 절차:**

uRPF를 프로덕션에 바로 적용하면 위험하므로, 단계적으로 적용합니다.

```
! ---- Step 1: Log 모드로 먼저 적용 (차단하지 않고 로깅만) ----
!
! ACL을 사용하여 Drop 대상을 로깅
ip access-list extended URPF-LOG
 permit ip any any log              ! 모든 uRPF 위반 패킷 로깅
!
interface GigabitEthernet0/0
 ip verify unicast source reachable-via any URPF-LOG
 ! ACL이 permit이면 uRPF 검사를 통과시키되 로그를 남김
 ! → 실제 차단 없이 어떤 트래픽이 uRPF에 걸리는지 확인 가능

! ---- Step 2: 로그 분석 (1~2주) ----
show logging | include URPF
show ip traffic | include RPF
!
! 로그에서 정상 트래픽이 uRPF에 매칭되는지 확인
! 비대칭 라우팅, 멀티캐스트, 터널 트래픽 등 확인

! ---- Step 3: 예외 처리 후 적용 ----
! 정상 트래픽이 걸리는 경우 ACL 예외 추가
! 문제 없으면 ACL을 deny any any로 변경하거나
! ACL 없이 적용

! ---- Step 4: 모니터링 ----
! 적용 후 지속적으로 RPF Drop 카운터 모니터링
show ip traffic | include RPF
! SNMP로 카운터 수집 → 그래프화 → 이상 증가 시 알림
```

이 단계적 접근이 중요한 이유는, uRPF는 한 번 적용하면 즉시 Drop이 시작되기 때문입니다. 특히 Strict Mode에서 사전 검증 없이 적용하면 정상 서비스에 바로 영향을 줄 수 있으므로, Log 모드 사전 검증은 필수 절차입니다.
