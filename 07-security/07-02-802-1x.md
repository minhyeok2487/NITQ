# 07-02. 802.1X 포트 인증

---

## 면접관: "고객사에서 사내 네트워크에 비인가 단말이 접속하는 걸 차단하고 싶다고 합니다. 개인 노트북이나 외부 업체 직원이 아무 포트에나 랜선 꽂으면 바로 통신이 되니까 보안 위협이 크다는 거죠. 어떻게 설계하시겠어요?"

802.1X 포트 기반 인증을 도입해서 인증된 단말만 네트워크에 접속할 수 있도록 설계하겠습니다.

전체 아키텍처는 다음과 같습니다.

- **인증 서버(Authentication Server)**: Cisco ISE를 이중화 구성 (PAN + PSN 분리, MnT 별도)
- **인증자(Authenticator)**: 액세스 스위치가 802.1X 인증 중계 역할
- **인증 요청자(Supplicant)**: 사용자 단말의 802.1X 클라이언트
- **인증 방식**: EAP-TLS (인증서 기반) 또는 PEAP (ID/PW 기반) - AD 연동
- **인증 실패 대비**: MAB(MAC Authentication Bypass) + Guest VLAN + Auth-Fail VLAN

> 토폴로지 이미지 추가 예정

### 핵심 설정

```
! ==== 스위치 글로벌 설정 ====
!
aaa new-model
!
! RADIUS 서버 정의
radius server ISE-PSN-1
 address ipv4 10.10.100.20 auth-port 1812 acct-port 1813
 key 0 R@d1us802!
 automate-tester username probe-test
!
radius server ISE-PSN-2
 address ipv4 10.10.100.21 auth-port 1812 acct-port 1813
 key 0 R@d1us802!
 automate-tester username probe-test
!
aaa group server radius ISE-GROUP
 server name ISE-PSN-1
 server name ISE-PSN-2
 deadtime 15
!
! AAA Method List
aaa authentication dot1x default group ISE-GROUP
aaa authorization network default group ISE-GROUP
aaa accounting dot1x default start-stop group ISE-GROUP
!
! 802.1X 글로벌 활성화
dot1x system-auth-control
!
! CoA 수신 설정 (ISE에서 권한 변경 시)
aaa server radius dynamic-author
 client 10.10.100.20 server-key R@d1us802!
 client 10.10.100.21 server-key R@d1us802!
!
! ==== 액세스 포트 설정 (사용자 포트) ====
!
interface GigabitEthernet1/0/1
 description USER-PORT
 switchport mode access
 switchport access vlan 100
 !
 ! 802.1X 인증 활성화
 authentication port-control auto
 authentication order dot1x mab
 authentication priority dot1x mab
 authentication host-mode multi-auth
 authentication open
 authentication periodic
 authentication timer reauthenticate server
 !
 ! 802.1X + MAB
 dot1x pam authenticator
 dot1x timeout tx-period 10
 mab
 !
 ! VLAN 정책
 authentication event fail action authorize vlan 999
 authentication event server dead action authorize vlan 100
 authentication event server dead action authorize voice
 authentication event no-response action authorize vlan 998
 !
 spanning-tree portfast
!
! ==== Uplink / Trunk 포트는 802.1X 제외 ====
!
interface GigabitEthernet1/0/48
 description UPLINK-TO-DIST
 switchport mode trunk
 ! 802.1X 적용하지 않음
```

---

## 면접관: "802.1X에서 Supplicant, Authenticator, Authentication Server 세 가지 역할이 있다고 하셨는데, 각각의 역할과 통신 흐름을 자세히 설명해주세요."

802.1X(IEEE 802.1X)는 포트 기반 네트워크 접근 제어(PNAC) 표준이며, 세 가지 구성 요소가 EAP(Extensible Authentication Protocol) 프레임워크 위에서 동작합니다.

```
[Supplicant]  ←── EAPoL ──→  [Authenticator]  ←── RADIUS/EAP ──→  [Auth Server]
  (단말)         (Layer 2)      (스위치)          (Layer 3)           (ISE)
```

**1. Supplicant (인증 요청자)**
- 사용자 단말에 설치된 802.1X 클라이언트 소프트웨어
- Windows 내장 Supplicant, Cisco AnyConnect NAM, SecureW2 등
- EAPoL(EAP over LAN) 프레임으로 Authenticator와 통신
- 인증 정보(인증서, ID/PW)를 제공

**2. Authenticator (인증자)**
- 액세스 스위치 역할, 중간 중계자
- Supplicant로부터 받은 EAP 메시지를 RADIUS 패킷으로 캡슐화해서 Auth Server로 전달
- 스스로 인증 판단을 하지 않음 (Proxy 역할)
- 인증 결과에 따라 포트를 열거나 차단

**3. Authentication Server (인증 서버)**
- 실제 인증 판단을 수행 (Cisco ISE, FreeRADIUS 등)
- 사용자 DB(AD, LDAP) 조회, 인증서 검증
- 인증 성공 시 VLAN, dACL(downloadable ACL) 등 인가 정보를 Authenticator에 전달

**통신 흐름 (PEAP 기준)**

```
Supplicant              Authenticator              ISE
    |                        |                       |
    |--- EAPoL-Start ------->|                       |
    |                        |--- RADIUS Access-Req ->|
    |<-- EAP-Request/ID -----|<-- EAP-Request/ID ----|
    |--- EAP-Response/ID --->|--- RADIUS(EAP) ------>|
    |                        |                       |
    |    (TLS Tunnel 수립 - PEAP Phase 1)            |
    |<== EAP-TLS Handshake ==========================>|
    |                        |                       |
    |    (Inner Auth - PEAP Phase 2: MSCHAPv2)       |
    |--- ID/PW (encrypted) ->|--- RADIUS(EAP) ------>|
    |                        |                       |
    |                        |<-- Access-Accept ------|
    |                        |    (VLAN, dACL 포함)   |
    |<-- EAP-Success --------|                       |
    |                        |                       |
    [포트 Authorized 상태]    [VLAN 할당, ACL 적용]
```

핵심은 Authenticator(스위치)는 EAP 페이로드의 내용을 해석하지 않고 그대로 전달만 한다는 점입니다. 인증 판단은 오직 Authentication Server(ISE)만 수행합니다.

---

## 면접관: "그런데 운영 중에 특정 층에 있는 프린터랑 IP폰이 802.1X 인증에 실패해서 네트워크에 접속을 못 한다고 합니다. 어디부터 확인하시겠어요?"

프린터와 IP폰은 802.1X Supplicant 기능이 없거나 제한적인 대표적인 장비입니다. 단계별로 확인하겠습니다.

**1단계: 문제 장비의 인증 상태 확인**

```
show authentication sessions interface Gi1/0/5
show authentication sessions interface Gi1/0/5 details
!
! 출력 예시:
! Status: Unauthorized
! Method: dot1x (Failed)
! Domain: DATA
```

`dot1x (Failed)`로 표시되면 Supplicant가 없거나 EAP 응답을 하지 못한 것입니다.

**2단계: IP폰 확인**

Cisco IP폰은 보통 CDP/LLDP로 Voice VLAN을 할당받고, multi-domain 모드에서 Voice domain으로 분리됩니다. 하지만 802.1X가 활성화된 포트에서는 추가 설정이 필요합니다.

```
interface GigabitEthernet1/0/5
 switchport mode access
 switchport access vlan 100
 switchport voice vlan 200
 !
 authentication host-mode multi-domain    ! Data + Voice 분리
 !
 ! IP폰은 CDP로 Voice VLAN 할당
 ! 802.1X 인증 실패해도 Voice VLAN은 허용하려면:
 authentication event fail action authorize vlan 999
 authentication event server dead action authorize voice
```

만약 IP폰이 EAP를 지원한다면 Supplicant로 인증 가능하지만, 미지원 모델이라면 **MAB(MAC Authentication Bypass)** 으로 전환해야 합니다.

**3단계: 프린터 → MAB Fallback 적용**

프린터는 802.1X Supplicant가 절대 없으므로 MAB을 사용합니다.

```
interface GigabitEthernet1/0/10
 description PRINTER
 switchport mode access
 switchport access vlan 300
 !
 authentication order dot1x mab        ! dot1x 먼저 시도 → 실패 시 MAB
 authentication priority dot1x mab
 authentication port-control auto
 !
 dot1x pam authenticator
 dot1x timeout tx-period 5             ! EAP 요청 대기 시간 단축
 dot1x max-reauth-req 1                ! 재시도 횟수 축소 (빨리 MAB 전환)
 mab                                   ! MAB 활성화
!
! ISE 측에서 해당 프린터 MAC 주소를 Endpoint DB에 등록
! Policy: MAB 인증 → Printer Profile → VLAN 300 할당
```

**MAB 동작 순서:**

```
1. 스위치가 EAPoL-Request를 3회 전송 (tx-period 간격)
2. Supplicant 응답 없음
3. 스위치가 MAB으로 전환
4. 단말의 Source MAC 주소를 RADIUS username/password로 사용
   (예: MAC 00:11:22:33:44:55 → username: 001122334455)
5. ISE가 Endpoint DB에서 MAC 조회 → 등록된 MAC이면 인증 성공
```

```
! MAB 동작 확인
show authentication sessions interface Gi1/0/10 details
!
! 정상 출력:
! Method: mab (Authc Success)
! Authorized By: Authentication Server
! VLAN Policy: 300
```

---

## 면접관: "인증 실패 시 Guest VLAN, Auth-Fail VLAN, Critical VLAN이 있다고 했는데, 이게 각각 언제 적용되는 건지 헷갈려요. 정리해주세요."

세 가지 VLAN은 각각 다른 실패 시나리오에 대응합니다. 정확히 구분해야 합니다.

| VLAN 유형 | 트리거 조건 | 대상 | 용도 |
|-----------|------------|------|------|
| **Guest VLAN** (no-response) | Supplicant가 아예 없음 (EAPoL 응답 없음) | 802.1X 미지원 단말 | 제한적 인터넷 접속 허용 |
| **Auth-Fail VLAN** (fail) | 인증 시도했으나 서버가 Reject | 잘못된 인증 정보 | 자가 등록 포털 등 |
| **Critical VLAN** (server dead) | AAA 서버가 응답 불가 | 모든 단말 | 서버 장애 시 기본 접속 보장 |

```
interface GigabitEthernet1/0/1
 ! Guest VLAN: Supplicant 없는 단말 → VLAN 998
 authentication event no-response action authorize vlan 998
 !
 ! Auth-Fail VLAN: 인증 실패(Reject) → VLAN 999
 authentication event fail action authorize vlan 999
 authentication event fail retry 2 action authorize vlan 999
 !
 ! Critical VLAN: ISE 서버 죽었을 때 → 기존 VLAN 유지
 authentication event server dead action authorize vlan 100
 authentication event server dead action authorize voice
 authentication event server alive action reinitialize
```

**실무에서 자주 혼동하는 포인트:**

- Guest VLAN은 EAPoL 응답이 아예 없을 때 동작합니다. MAB도 실패한 후 최종적으로 떨어지는 VLAN입니다. `authentication order dot1x mab` 환경에서는 dot1x timeout → MAB 시도 → MAB도 실패 → 그래야 Guest VLAN으로 갑니다.
- Auth-Fail VLAN은 서버가 명시적으로 "이 사용자 안 돼"라고 Reject를 보냈을 때입니다. 서버가 죽어서 응답이 없는 것과는 다릅니다.
- Critical VLAN에서 `server alive action reinitialize`를 설정하면, ISE가 복구되었을 때 자동으로 재인증을 시도합니다. 이걸 빠뜨리면 서버가 복구되어도 단말이 Critical VLAN에 남아있게 됩니다.

---

## 면접관: "고객사에서 회의실에 외부 손님이 오면 네트워크를 쓸 수 있게 해달라고 합니다. 하지만 사내 네트워크와는 완전히 분리되어야 하고, 사용자 등록 절차도 있어야 한대요."

ISE의 Guest Portal 기능과 802.1X + MAB + WebAuth를 조합해서 설계하겠습니다.

**게스트 접속 흐름:**

```
1. 외부 손님이 회의실 포트에 노트북 연결
2. 802.1X Supplicant 없음 → MAB 시도 → MAC 미등록 → 실패
3. ISE가 Authorization Profile로 "URL-Redirect to Guest Portal" 전달
4. 손님이 브라우저 열면 → Guest Self-Registration Portal로 리다이렉트
5. 이름, 회사명, 이메일, 방문 목적 입력
6. 스폰서(사내 직원)에게 승인 메일 발송
7. 스폰서 승인 → ISE가 CoA 발송 → 스위치가 Guest VLAN으로 전환
8. 인터넷만 접속 가능 (사내 네트워크 차단)
```

```
! 스위치 포트 설정 (회의실)
interface GigabitEthernet1/0/20
 description MEETING-ROOM
 switchport mode access
 switchport access vlan 100
 !
 authentication port-control auto
 authentication order dot1x mab webauth
 authentication priority dot1x mab webauth
 !
 dot1x pam authenticator
 dot1x timeout tx-period 5
 mab
 !
 ip access-group ACL-WEBAUTH-REDIRECT in
!
! WebAuth 리다이렉트용 ACL
ip access-list extended ACL-WEBAUTH-REDIRECT
 permit udp any any eq domain
 permit udp any any eq bootpc
 permit udp any any eq bootps
 deny   ip any any
```

ISE 측에서는 Guest VLAN(예: VLAN 500)에 대해 인터넷 접속만 허용하는 dACL을 적용하고, 사내 서버 대역(10.0.0.0/8)으로의 접근은 모두 차단합니다.

게스트 계정에는 유효 기간(예: 8시간)을 설정해서 회의가 끝나면 자동 만료되도록 합니다.

---

## 면접관: "EAP 종류가 여러 가지 있다고 했는데, PEAP, EAP-TLS, EAP-FAST 차이를 설명해주세요. 고객사에 어떤 걸 추천하시겠어요?"

주요 EAP 방식의 비교입니다.

| 항목 | PEAP | EAP-TLS | EAP-FAST |
|------|------|---------|----------|
| **인증 방식** | 서버 인증서 + 내부 ID/PW (MSCHAPv2) | 서버 인증서 + 클라이언트 인증서 (상호 인증) | PAC(Protected Access Credential) 기반 |
| **인증서 필요** | 서버 측만 | 서버 + 클라이언트 양쪽 | 불필요 (PAC 자동 프로비저닝) |
| **보안 수준** | 높음 | 최고 | 높음 |
| **배포 난이도** | 중간 (AD 연동 용이) | 높음 (PKI 인프라 필수) | 낮음 |
| **개발** | Microsoft + Cisco | IETF 표준 | Cisco 독자 |

**추천 기준:**

- **PKI 인프라가 이미 있는 기업**: EAP-TLS 추천. 클라이언트 인증서로 상호 인증하므로 보안이 가장 강력합니다. 인증서 탈취가 아니면 사칭이 거의 불가능합니다.
- **AD는 있지만 PKI가 없는 기업**: PEAP(MSCHAPv2) 추천. 기존 AD 계정으로 바로 인증 가능하고 배포가 가장 현실적입니다. 대부분의 기업이 이 방식을 선택합니다.
- **Cisco 장비 중심 환경**: EAP-FAST도 고려 가능. 인증서 없이도 빠르게 배포할 수 있지만, Cisco 독자 규격이므로 멀티벤더 환경에서는 호환 문제가 있을 수 있습니다.

```
! PEAP 사용 시 스위치 측 추가 설정은 특별히 없음
! EAP 협상은 Supplicant ↔ ISE 간에 이루어지고
! 스위치는 EAP 페이로드를 투명하게 전달만 함
!
! 다만, ISE Allowed Protocols에서 허용할 EAP 방식을 지정:
! ISE > Policy > Policy Elements > Results > Allowed Protocols
! - Allow PEAP: Yes
! - Allow EAP-TLS: Yes (인증서 환경인 경우)
! - Inner Method: MSCHAPv2 (PEAP 사용 시)
```

실무에서 가장 많이 보는 조합은 **사내 직원은 PEAP(MSCHAPv2) + AD 연동, 비인가 장비는 MAB, 게스트는 WebAuth**입니다. 이 세 가지를 ISE Policy Set에서 순서대로 매칭되도록 구성하면 대부분의 시나리오를 커버할 수 있습니다.
