# 07-05. CoPP (Control Plane Policing)

---

## 면접관: "고객사에서 코어 라우터 CPU 사용률이 갑자기 100%까지 올라가면서 OSPF Neighbor가 끊기고, SSH 접속도 안 되는 장애가 발생했습니다. 확인해보니 외부에서 대량의 ICMP 패킷이 들어오고 있었어요. 이런 상황이 재발하지 않도록 대책을 세워달라고 합니다. 어떻게 하시겠어요?"

이 장애는 **Control Plane에 대한 DoS 공격**입니다. 대량의 ICMP가 라우터 CPU로 직접 전달되면서 라우팅 프로토콜(OSPF) 처리와 관리 세션(SSH)이 모두 영향받은 것입니다.

**CoPP(Control Plane Policing)** 를 적용하여 Control Plane으로 향하는 트래픽을 유형별로 분류하고, 각각 적정 Rate로 Policing하겠습니다.

설계 원칙:
- **라우팅 프로토콜 트래픽**: 최우선 보장 (OSPF, BGP, EIGRP 등)
- **관리 트래픽**: 보장하되 Rate 제한 (SSH, SNMP, NTP)
- **일반 트래픽**: 제한적 허용 (ICMP, Traceroute)
- **불필요/악성 트래픽**: 최소 Rate 또는 차단 (나머지 전부)

> 토폴로지 이미지 추가 예정

### 핵심 설정

```
! ==== Step 1: ACL로 트래픽 분류 ====
!
! --- 라우팅 프로토콜 (최우선) ---
ip access-list extended ACL-ROUTING
 permit ospf any any
 permit tcp any eq 179 any               ! BGP
 permit tcp any any eq 179               ! BGP
 permit eigrp any any
 permit pim any any
!
! --- 관리 트래픽 ---
ip access-list extended ACL-MANAGEMENT
 permit tcp 10.10.0.0 0.0.255.255 any eq 22          ! SSH (관리 대역만)
 permit udp 10.10.0.0 0.0.255.255 any eq 161         ! SNMP
 permit udp any any eq 123                            ! NTP
 permit udp any eq 123 any                            ! NTP 응답
 permit tcp 10.10.100.10 0.0.0.1 eq 49 any            ! TACACS+
!
! --- ICMP (제한적 허용) ---
ip access-list extended ACL-ICMP
 permit icmp any any echo
 permit icmp any any echo-reply
 permit icmp any any unreachable
 permit icmp any any ttl-exceeded
!
! --- 나머지 (기본 차단/최소 허용) ---
ip access-list extended ACL-UNDESIRED
 permit ip any any
!
!
! ==== Step 2: Class-Map으로 분류 ====
!
class-map match-all CLASS-ROUTING
 match access-group name ACL-ROUTING
!
class-map match-all CLASS-MANAGEMENT
 match access-group name ACL-MANAGEMENT
!
class-map match-all CLASS-ICMP
 match access-group name ACL-ICMP
!
class-map match-all CLASS-UNDESIRED
 match access-group name ACL-UNDESIRED
!
!
! ==== Step 3: Policy-Map으로 Rate 설정 ====
!
policy-map COPP-POLICY
 !
 class CLASS-ROUTING
  police rate 500 pps burst 100 packets
   conform-action transmit
   exceed-action transmit
  ! 라우팅은 무조건 통과 (또는 넉넉한 Rate)
 !
 class CLASS-MANAGEMENT
  police rate 200 pps burst 50 packets
   conform-action transmit
   exceed-action drop
  ! 관리 트래픽은 200pps 초과 시 Drop
 !
 class CLASS-ICMP
  police rate 100 pps burst 25 packets
   conform-action transmit
   exceed-action drop
  ! ICMP는 100pps 제한 (이번 장애 재발 방지)
 !
 class CLASS-UNDESIRED
  police rate 50 pps burst 10 packets
   conform-action drop
   exceed-action drop
  ! 분류되지 않은 나머지는 차단
 !
 class class-default
  police rate 50 pps burst 10 packets
   conform-action transmit
   exceed-action drop
!
!
! ==== Step 4: Control Plane에 적용 ====
!
control-plane
 service-policy input COPP-POLICY
!
!
! ==== 확인 명령어 ====
show policy-map control-plane
show policy-map control-plane input class CLASS-ICMP
show policy-map control-plane input class CLASS-ROUTING
```

---

## 면접관: "Data Plane, Control Plane, Management Plane이 뭔지 설명해주세요. CoPP는 왜 Control Plane만 보호하나요?"

네트워크 장비는 기능적으로 세 개의 Plane으로 나뉩니다. 이 구분을 이해해야 CoPP의 동작 원리를 파악할 수 있습니다.

### 1. Data Plane (Forwarding Plane)

- **역할**: 사용자 트래픽의 실제 전달 (패킷 포워딩)
- **처리**: ASIC/TCAM 하드웨어에서 고속 처리 (CEF/FIB 기반)
- **예시**: PC A에서 PC B로 가는 트래픽이 라우터를 Transit하는 것
- **특징**: CPU를 사용하지 않음 (Wire-Speed)

### 2. Control Plane

- **역할**: 라우팅 프로토콜 처리, ARP, STP, ICMP 등
- **처리**: CPU(Route Processor)에서 소프트웨어로 처리
- **예시**: OSPF Hello 패킷 수신/전송, BGP Update 처리, ARP 요청 응답
- **특징**: CPU 자원 사용, 제한된 처리 능력

### 3. Management Plane

- **역할**: 장비 관리 접근 (SSH, SNMP, Syslog, NTP 등)
- **처리**: CPU에서 소프트웨어로 처리
- **예시**: 관리자가 SSH로 장비 접속, SNMP Polling, NTP 동기화
- **특징**: Control Plane의 일부로 보기도 함

```
┌─────────────────────────────────────────┐
│              CPU (Route Processor)       │
│  ┌──────────────┐  ┌──────────────────┐ │
│  │ Control Plane│  │ Management Plane │ │
│  │ OSPF, BGP    │  │ SSH, SNMP, NTP   │ │
│  │ ARP, ICMP    │  │ Syslog, TACACS+  │ │
│  └──────┬───────┘  └────────┬─────────┘ │
│         └─────────┬──────────┘           │
│                   │ Punted Traffic       │
│                   │ (CPU로 올라온 패킷)   │
├───────────────────┼─────────────────────┤
│                   │                     │
│  ┌────────────────┴───────────────────┐ │
│  │         Data Plane (ASIC/TCAM)     │ │
│  │  FIB Lookup → 패킷 포워딩           │ │
│  │  Wire-Speed 처리                    │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**CoPP가 Control Plane을 보호하는 이유:**

Data Plane은 ASIC 하드웨어에서 처리하므로 대량의 트래픽에도 성능 저하가 거의 없습니다. 하지만 라우터/스위치 자체를 목적지로 하는 트래픽(ICMP to router, OSPF Hello, SSH 접속 등)은 CPU로 "Punt"되어 소프트웨어 처리됩니다.

CPU 처리 능력은 제한적이므로, 대량의 트래픽이 CPU로 몰리면:
- 라우팅 프로토콜 처리 지연 → Neighbor Down → 네트워크 전체 장애
- 관리 접속 불가 → 장애 대응 자체가 불가능
- ARP 처리 지연 → 통신 장애

**CoPP는 CPU에 도달하기 전에 트래픽을 분류하고 Rate Limiting을 적용하여, 중요한 트래픽(라우팅 프로토콜)은 보장하면서 불필요한 트래픽은 제한합니다.**

---

## 면접관: "그런데 CoPP를 적용하고 나서 오히려 OSPF Neighbor가 끊어졌다고 합니다. CoPP 적용 전에는 잘 되던 건데요. 원인이 뭘까요?"

CoPP 설정에서 가장 흔한 실수입니다. **class-map 분류 순서 문제**입니다.

**원인 분석:**

Policy-Map의 class 매칭은 **순서대로(Top-Down)** 동작합니다. 문제는 OSPF 패킷이 의도한 CLASS-ROUTING이 아닌 다른 class에 먼저 매칭되어 Drop되는 경우입니다.

```
! 잘못된 설정 예시
!
class-map match-all CLASS-UNDESIRED
 match access-group name ACL-UNDESIRED    ! permit ip any any
!
policy-map COPP-POLICY
 class CLASS-UNDESIRED        ← 이것이 먼저 매칭되면
  police rate 50 pps            OSPF도 여기서 Drop됨!
   conform-action drop
   exceed-action drop
 class CLASS-ROUTING          ← OSPF가 여기까지 도달 못 함
  police rate 500 pps
   conform-action transmit
```

하지만 실제로 MQC(Modular QoS CLI)의 policy-map에서는 **class 순서대로** 매칭하되, 각 class-map이 참조하는 ACL이 독립적으로 매칭됩니다. 패킷이 여러 class에 동시에 매칭될 수 있는 경우, **먼저 나오는 class가 우선**합니다.

**해결:**

```
! Policy-Map에서 CLASS-ROUTING을 가장 먼저 배치
!
policy-map COPP-POLICY
 class CLASS-ROUTING          ← 1순위: OSPF/BGP 보장
  police rate 500 pps burst 100 packets
   conform-action transmit
   exceed-action transmit     ← 초과해도 통과 (라우팅은 무조건 보호)
 !
 class CLASS-MANAGEMENT       ← 2순위: 관리 트래픽
  police rate 200 pps burst 50 packets
   conform-action transmit
   exceed-action drop
 !
 class CLASS-ICMP             ← 3순위: ICMP 제한
  police rate 100 pps burst 25 packets
   conform-action transmit
   exceed-action drop
 !
 class class-default          ← 최후: 나머지 전부
  police rate 50 pps burst 10 packets
   conform-action transmit
   exceed-action drop
```

**또 다른 흔한 원인: ACL에서 OSPF 프로토콜 누락**

```
! OSPF는 IP Protocol 89 사용
! ACL에서 ospf가 아니라 tcp/udp로만 매칭하면 OSPF 패킷이 빠짐
!
! 잘못된 ACL
ip access-list extended ACL-ROUTING
 permit tcp any eq 179 any              ! BGP만 있음
 ! OSPF 누락!
!
! 올바른 ACL
ip access-list extended ACL-ROUTING
 permit ospf any any                    ! OSPF (Protocol 89)
 permit tcp any eq 179 any              ! BGP
 permit tcp any any eq 179
 permit eigrp any any                   ! EIGRP (Protocol 88)
 permit udp any any eq 520             ! RIPv2
 permit pim any any                    ! PIM Multicast
```

**검증 명령어:**

```
! CoPP 적용 후 각 class별 매칭/Drop 카운터 확인
show policy-map control-plane input
!
! 출력 예시:
! Class-map: CLASS-ROUTING (match-all)
!   523 packets, 41840 bytes
!   police:
!     conformed 523 packets  ← OSPF 패킷이 여기서 매칭되는지 확인
!     exceeded 0 packets
!
! Class-map: class-default
!   89234 packets, 7138720 bytes
!   police:
!     conformed 1200 packets
!     exceeded 88034 packets  ← Drop된 패킷
!                               OSPF가 여기서 Drop되고 있다면 분류 오류!

! 실시간 확인
show policy-map control-plane input class CLASS-ROUTING
```

CLASS-ROUTING의 카운터가 증가하지 않고, class-default에서 대량 Drop이 발생하고 있다면 OSPF 패킷이 올바르게 분류되지 않은 것입니다.

---

## 면접관: "police rate를 어떤 기준으로 정하나요? 너무 낮으면 정상 트래픽도 Drop되고, 너무 높으면 보호 효과가 없잖아요."

Rate 결정은 CoPP 설계에서 가장 어려운 부분입니다. 기준은 **평시 트래픽 측정 + 여유분**입니다.

**1단계: 평시 Control Plane 트래픽 측정**

CoPP를 적용하기 전에 먼저 현재 Control Plane 트래픽의 Baseline을 측정합니다.

```
! Control Plane에 도달하는 트래픽 통계
show processes cpu history
show processes cpu sorted | head 20
!
! 프로토콜별 패킷 카운터
show ip traffic
!
! OSPF 관련 트래픽 양 확인
show ip ospf traffic
!
! BGP 관련
show ip bgp summary        ! Neighbor 수, Update 빈도
!
! 인터페이스별 Input Rate
show interfaces GigabitEthernet0/0 | include input rate
```

**2단계: Rate 산정 기준**

| 트래픽 유형 | 산정 기준 | 참고 Rate |
|------------|----------|-----------|
| **OSPF** | Neighbor 수 x Hello 빈도 + LSA Update | 200~500 pps |
| **BGP** | Peer 수 x Update 빈도 (Convergence 시 급증) | 300~1000 pps |
| **SSH** | 동시 관리 세션 수 x 세션당 패킷 | 100~300 pps |
| **SNMP** | Polling 간격 x OID 수 | 100~500 pps |
| **ICMP** | Ping 모니터링 + Traceroute | 50~200 pps |
| **ARP** | VLAN 크기, 호스트 수 | 200~1000 pps |

**핵심 원칙:**
- **라우팅 프로토콜**: 평시 트래픽의 **3~5배** 여유 (Convergence 시 LSA/Update 급증)
- **관리 트래픽**: 평시 트래픽의 **2~3배** 여유
- **ICMP**: 최소한으로 제한 (모니터링 용도만 충분히)
- **나머지**: 최소 Rate 또는 Drop

**3단계: 적용 후 모니터링 & 조정**

```
! 적용 후 주기적 확인 (최소 1주일)
show policy-map control-plane input
!
! exceed 카운터가 지속 증가하는 class가 있다면:
! → 정상 트래픽이 Drop되고 있을 가능성
! → Rate 상향 조정 필요
!
! conform만 있고 exceed가 0인 class:
! → Rate를 너무 높게 잡은 것 (보호 효과 약함)
! → Rate 하향 가능
```

OSPF Convergence 이벤트(링크 Flap, 대량 LSA)를 시뮬레이션해서 해당 시점의 트래픽 급증도 CoPP Rate 내에서 처리되는지 테스트하는 것이 이상적입니다.

---

## 면접관: "CoPP보다 더 세밀한 Control Plane 보호 방법이 있다고 들었는데, CPPr이 뭔가요?"

CPPr(Control Plane Protection)은 CoPP의 확장 버전으로, Control Plane을 **세 개의 Sub-Interface로 분리**하여 더 세밀한 정책을 적용합니다.

CoPP는 Control Plane 전체를 하나의 단위로 보호하지만, CPPr은 다음과 같이 나눕니다.

```
┌─────────────────── Control Plane ───────────────────┐
│                                                      │
│  ┌──────────────┐ ┌────────────┐ ┌────────────────┐ │
│  │  Host        │ │  Transit   │ │   CEF-Exception│ │
│  │  Sub-IF      │ │  Sub-IF    │ │   Sub-IF       │ │
│  │              │ │            │ │                │ │
│  │ 장비 자체가   │ │ SW 전환    │ │ CEF에서 처리   │ │
│  │ 목적지인     │ │ 필요한     │ │ 못 해서 CPU로  │ │
│  │ 트래픽       │ │ Transit    │ │ Punt된 패킷    │ │
│  │              │ │ 트래픽     │ │                │ │
│  │ SSH, SNMP    │ │ IP Options │ │ ARP Glean     │ │
│  │ OSPF, BGP    │ │ TTL Expire │ │ ICMP Redirect │ │
│  │ ICMP to self │ │ Fragmented │ │ FIB miss      │ │
│  └──────────────┘ └────────────┘ └────────────────┘ │
└──────────────────────────────────────────────────────┘
```

### CPPr 설정

```
! ==== Host Sub-Interface: 장비 자체 목적 트래픽 ====
!
class-map match-all CPPR-HOST-ROUTING
 match access-group name ACL-ROUTING
!
class-map match-all CPPR-HOST-MGMT
 match access-group name ACL-MANAGEMENT
!
policy-map CPPR-HOST-POLICY
 class CPPR-HOST-ROUTING
  police rate 500 pps burst 100 packets
   conform-action transmit
   exceed-action transmit
 class CPPR-HOST-MGMT
  police rate 200 pps burst 50 packets
   conform-action transmit
   exceed-action drop
 class class-default
  police rate 50 pps burst 10 packets
   conform-action transmit
   exceed-action drop
!
!
! ==== Transit Sub-Interface: SW 전환 필요한 Transit 트래픽 ====
!
class-map match-all CPPR-TRANSIT-IPOPTIONS
 match ip-option any                  ! IP Options 포함 패킷
!
class-map match-all CPPR-TRANSIT-FRAGMENT
 match ip-fragment                    ! Fragment 패킷
!
policy-map CPPR-TRANSIT-POLICY
 class CPPR-TRANSIT-IPOPTIONS
  police rate 100 pps burst 25 packets
   conform-action transmit
   exceed-action drop
 class CPPR-TRANSIT-FRAGMENT
  police rate 200 pps burst 50 packets
   conform-action transmit
   exceed-action drop
 class class-default
  police rate 100 pps burst 25 packets
   conform-action transmit
   exceed-action drop
!
!
! ==== CEF-Exception Sub-Interface: CEF Punt 트래픽 ====
!
policy-map CPPR-CEF-POLICY
 class class-default
  police rate 500 pps burst 100 packets
   conform-action transmit
   exceed-action drop
!
!
! ==== Control Plane에 적용 ====
!
control-plane host
 service-policy input CPPR-HOST-POLICY
!
control-plane transit
 service-policy input CPPR-TRANSIT-POLICY
!
control-plane cef-exception
 service-policy input CPPR-CEF-POLICY
!
!
! ==== 확인 ====
show policy-map control-plane host input
show policy-map control-plane transit input
show policy-map control-plane cef-exception input
```

**CoPP vs CPPr 비교:**

| 항목 | CoPP | CPPr |
|------|------|------|
| **분류 단위** | Control Plane 전체 (1개) | Host/Transit/CEF-Exception (3개) |
| **세밀도** | 트래픽 유형별 분류 | Sub-Interface별 + 트래픽 유형별 |
| **Port Filter** | 불가 | Host Sub-IF에서 특정 Port만 허용 가능 |
| **설정 복잡도** | 상대적으로 단순 | 복잡하지만 정밀 |
| **플랫폼** | 대부분 지원 | IOS 12.4(4)T 이상, ISR 시리즈 |

**실무 선택 기준:**
- 대부분의 환경에서는 **CoPP로 충분**합니다. 올바른 class-map 분류와 적정 Rate만 설정하면 Control Plane을 효과적으로 보호할 수 있습니다.
- CPPr은 Transit 트래픽(IP Options, Fragment)을 별도로 제어해야 하거나, 특정 포트로의 접근만 허용하는 Port Filtering이 필요한 환경에서 사용합니다.

---

## 면접관: "고객사가 Nexus 스위치도 운영하고 있는데, NX-OS에서 CoPP는 어떻게 다른가요?"

NX-OS(Nexus)에서는 CoPP가 **기본적으로 활성화**되어 있습니다. IOS와의 주요 차이점을 정리하겠습니다.

**NX-OS CoPP 특징:**
- **Default CoPP**: 출고 시 기본 CoPP 정책이 적용되어 있음 (IOS는 수동 설정)
- **Hardware 기반**: Memory/TCAM에서 처리하여 성능 영향 최소
- **사전 정의 Class**: Nexus가 자동으로 트래픽을 분류해둠

```
! ==== NX-OS CoPP 확인 ====
!
! 현재 CoPP 정책 확인
show copp status
show policy-map interface control-plane
!
! 기본 CoPP 프로파일 확인
show copp profile
!
! 출력 예시:
! copp-system-p-class-critical       → BGP, OSPF, EIGRP
! copp-system-p-class-important      → TACACS+, RADIUS
! copp-system-p-class-management     → SSH, SNMP, NTP
! copp-system-p-class-normal         → ICMP, Traceroute
! copp-system-p-class-undesirable    → 나머지
! copp-system-p-class-l2-default     → L2 프로토콜 (STP, LACP)

! ==== NX-OS CoPP 커스터마이징 ====
!
! 기본 프로파일 복사 후 수정 (원본 직접 수정은 비권장)
copp copy profile strict prefix MY-COPP
!
! 커스텀 Class-Map 수정
class-map type control-plane match-any MY-COPP-class-critical
 match access-group name MY-COPP-acl-bgp
 match access-group name MY-COPP-acl-ospf
 match access-group name MY-COPP-acl-eigrp
!
! Policy-Map Rate 수정
policy-map type control-plane MY-COPP-policy
 class MY-COPP-class-critical
  set cos 7
  police pps 2000
 class MY-COPP-class-normal
  set cos 1
  police pps 300
!
! 적용
control-plane
 service-policy input MY-COPP-policy
!
! ==== CoPP 프로파일 선택 (간편 방법) ====
! Nexus는 사전 정의 프로파일 제공:
!   strict  : 가장 엄격한 Rate 제한
!   moderate: 중간
!   lenient : 느슨한 Rate 제한
!   dense   : 고밀도 포트 환경
!
copp profile strict
! → 사전 정의된 strict 프로파일 일괄 적용
```

**IOS vs NX-OS CoPP 핵심 차이 정리:**

| 항목 | IOS (ISR/ASR) | NX-OS (Nexus) |
|------|---------------|---------------|
| **기본 상태** | 수동 설정 필요 | 기본 활성화 |
| **프로파일** | 없음 (직접 작성) | strict/moderate/lenient/dense |
| **분류** | 직접 ACL + class-map | 사전 정의 class 제공 |
| **적용** | `control-plane` > `service-policy` | 동일 |
| **Type 지정** | 불필요 | `type control-plane` 필요 |
| **모니터링** | `show policy-map control-plane` | `show policy-map interface control-plane` |

NX-OS 환경에서는 기본 CoPP가 이미 적용되어 있으므로, 별도 설정 없이도 기본적인 보호는 됩니다. 다만 고객사 환경에 맞게 Rate를 튜닝하려면 사전 정의 프로파일을 복사해서 커스터마이징하는 것이 Best Practice입니다. 기본 프로파일을 직접 수정하면 NX-OS 업그레이드 시 덮어씌워질 수 있으므로, 반드시 복사본을 만들어서 사용합니다.
