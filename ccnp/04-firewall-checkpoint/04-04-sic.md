# 04-04. SIC (Secure Internal Communication)

---

### 면접관: "고객사에서 Management Server와 Gateway 간 통신이 안 된다고 연락이 왔습니다. SmartConsole에서 Gateway 상태가 빨간색으로 뜨고 정책 설치도 안 되는 상황인데, 어디부터 확인하시겠어요?"

Management-Gateway 간 통신 장애는 크게 **네트워크 문제**, **SIC 문제**, **데몬 문제** 세 가지로 나눕니다. 순서대로 확인합니다.

#### 1단계: 기본 네트워크 연결 확인

```
# Management Server에서 Gateway로 ping
ping <Gateway_IP>

# Gateway에서 Management로 ping
ping <Management_IP>

# 양쪽 인터페이스 상태 확인 (Clish)
show interface eth0
show route
```

#### 2단계: SIC 상태 확인

```
# SmartConsole에서:
# Gateway Object 더블클릭 → General Properties
# → "Communication" 버튼 클릭
# → SIC Status 확인:
#    - "Communicating" (녹색) → 정상
#    - "Uninitialized" → SIC 초기화 안 됨
#    - "Not Communicating" → SIC 인증 실패 또는 네트워크 문제
#    - "Trust established" → 인증서 교환 완료, but 통신 안 됨

# Gateway에서 SIC 상태 확인 (Expert Mode)
cpconfig
# 메뉴에서 Secure Internal Communication 선택
# → 현재 SIC 상태 표시

# SIC 관련 포트 확인
netstat -tlnp | grep 18211    # SIC 인증서 교환 포트
netstat -tlnp | grep 18191    # cpd 데몬 포트
```

#### 3단계: CP 데몬 상태 확인

```
# Gateway Expert Mode
cpwd_admin list

# 정상 출력 예시:
# APP         PID     STATUS
# CPD         1234    E (Enabled)
# FWD         1235    E
# CPMAD       1236    E
# FWM         -       N/A (Gateway에는 없음)

# Management Server Expert Mode
cpwd_admin list
# FWM, CPD, CPMAD 등 모두 E 상태여야 함

# 데몬이 비정상이면 재시작
cpstop && cpstart
```

> 토폴로지 이미지 추가 예정

---

### 면접관: "SIC가 정확히 뭡니까? 어떤 원리로 동작하는지 설명해주세요."

**SIC(Secure Internal Communication)** 은 Check Point 구성 요소 간의 모든 통신을 **TLS 기반 인증서**로 암호화하고 인증하는 메커니즘입니다.

#### SIC가 보호하는 통신

| 통신 구간 | 용도 |
|-----------|------|
| Management Server ↔ Security Gateway | 정책 배포, 상태 모니터링 |
| Management Server ↔ Log Server | 로그 전송 |
| SmartConsole ↔ Management Server | 관리 접속 |
| Gateway ↔ Gateway | ClusterXL HA 동기화, VPN 등 |

#### SIC 동작 원리

```
# SIC는 PKI(Public Key Infrastructure) 기반:

# 1. Management Server = CA (Certificate Authority) 역할
#    - Management 초기 설정(FTW) 시 Internal CA(ICA) 자동 생성
#    - 이 ICA가 모든 Check Point 구성 요소에 인증서를 발급

# 2. SIC 초기화 과정 (Trust Establishment):
#
#    [Gateway]                        [Management Server]
#       |                                    |
#       |  1. FTW에서 SIC Activation Key 설정  |
#       |                                    |
#       |  2. SmartConsole에서 Gateway 오브젝트 |
#       |     생성 시 같은 Activation Key 입력  |
#       |                                    |
#       |  3. Management → Gateway 접속 시도    |
#       |     (TCP 18211)                     |
#       |                                    |
#       |  4. Activation Key로 상호 인증       |
#       |                                    |
#       |  5. Management(ICA)가 Gateway에      |
#       |     TLS 인증서 발급                  |
#       |                                    |
#       |  6. 이후 모든 통신은 이 인증서로      |
#       |     TLS 암호화                       |
#       |                                    |

# 3. Trust 수립 후:
#    - Activation Key는 더 이상 사용 안 됨 (1회성)
#    - 인증서 기반으로 상호 인증
#    - 모든 Control 통신이 TLS로 암호화
```

#### 핵심 포인트

- **Activation Key**는 최초 Trust 수립 시에만 사용되는 **일회용 공유 비밀**
- Trust 수립 후에는 **X.509 인증서** 기반 인증으로 전환
- Management Server의 **Internal CA(ICA)** 가 모든 인증서를 발급/관리
- SIC 인증서의 **CN(Common Name)** 은 해당 장비의 **SIC Name** (예: `cn=cp_mgmt,o=myorg..`)

```
# SIC Name 확인 (Expert Mode)
cpconfig
# → Secure Internal Communication 메뉴에서 SIC Name 표시

# 또는
fwm sic_name     # Management Server에서
fw sic_name      # Gateway에서

# ICA 인증서 정보 확인
cpca_client lscert    # 발급된 인증서 목록
```

---

### 면접관: "SIC 상태가 Uninitialized로 뜹니다. 어떻게 해결하시겠어요?"

SIC **Uninitialized** 상태는 Gateway에서 SIC가 초기화되지 않았거나, 리셋된 상태입니다. Trust를 처음부터 다시 수립해야 합니다.

#### 원인 파악

```
# Uninitialized가 되는 경우:
# 1. Gateway FTW에서 SIC Activation Key를 설정하지 않은 경우
# 2. cpconfig에서 SIC Reset을 실행한 경우
# 3. 장비 교체/재설치 후 SIC 재설정이 필요한 경우
# 4. Management Server를 교체한 경우 (새 CA이므로 기존 인증서 무효)
```

#### 해결 절차

```
# === Gateway 측 작업 ===

# 1. Gateway에 SSH 접속 → Expert Mode
expert

# 2. SIC 초기화 (Activation Key 재설정)
cpconfig
# → Secure Internal Communication 메뉴 선택
# → "Do you want to reset SIC?" → y
# → 새 Activation Key 입력 (Management에서도 동일하게 입력할 것)
# → Activation Key 확인 입력

# 3. CP 서비스 재시작
cpstop
cpstart

# 4. SIC 상태 확인
cpconfig
# → SIC Status: Initialized but trust not established
```

```
# === Management 측 작업 (SmartConsole) ===

# 1. SmartConsole에서 해당 Gateway Object 더블클릭
# 2. General Properties → "Communication" 버튼 클릭
# 3. "Reset" 버튼 클릭 (기존 Trust 제거)
# 4. Activation Key 입력 (Gateway에서 설정한 것과 동일한 키)
# 5. "Initialize" 클릭

# 6. SIC Status가 "Communicating"으로 변경되면 성공
# 7. "OK" → Publish → Install Policy
```

#### SIC 초기화 실패 시 추가 점검

```
# 1. Activation Key 불일치
#    → 양쪽에서 정확히 같은 Key를 입력했는지 확인
#    → 대소문자, 특수문자 주의

# 2. 네트워크 차단
#    → Management → Gateway TCP 18211 포트 통신 확인
telnet <Gateway_IP> 18211     # Management에서 테스트

# 3. Gateway CPU/메모리 이슈로 데몬 비정상
cpwd_admin list               # Gateway에서 CPD 상태 확인
cpstat os -f cpu              # CPU 사용률
cpstat os -f memory           # 메모리 사용률

# 4. 시간 동기화 문제
#    인증서 유효성 검사 시 시간이 맞지 않으면 실패
date                          # 양쪽 장비 시간 확인
show ntp active               # Clish에서 NTP 동기화 확인
ntpstat                       # NTP 상태
```

---

### 면접관: "SIC Reset 과정을 좀 더 자세히 설명해주세요. 운영 중인 환경에서 SIC Reset을 하면 어떤 영향이 있습니까?"

SIC Reset은 해당 장비의 **SIC 인증서를 폐기**하고, Trust 관계를 완전히 끊는 작업입니다. 운영 환경에서는 매우 신중하게 진행해야 합니다.

#### SIC Reset 시 영향

| 영향 항목 | 설명 |
|-----------|------|
| **정책 배포 불가** | Trust가 끊기므로 새 정책 Install 불가 |
| **기존 정책 유지** | 이미 설치된 정책은 Gateway에서 계속 동작 |
| **로그 전송 중단** | Gateway → Management/Log Server 로그 전송 중단 |
| **HA 동기화 중단** | ClusterXL 환경에서 State Synchronization 중단 가능 |
| **모니터링 불가** | SmartConsole에서 해당 Gateway 상태 확인 불가 |

#### SIC Reset 상세 절차 (Expert Mode)

```
# Gateway에서 SIC Reset:
expert
cpconfig

# 메뉴 출력:
# (1) Licenses and Contracts
# (2) Administrator
# (3) GUI Clients
# (4) SNMP Extension
# (5) Random Pool
# (6) Secure Internal Communication    ← 선택
# (7) ...

# "The SIC is currently initialized. Do you want to reset it? (y/n)" → y
# "Enter Activation Key:" → 새 키 입력
# "Retype Activation Key:" → 확인

# 완료 후 CP 재시작 필수
cpstop
cpstart
```

#### 운영 환경에서의 SIC Reset 절차 (Best Practice)

```
# 1. 작업 전 공지 및 유지보수 시간 확보
#    → SIC Reset 동안 정책 변경 불가

# 2. 현재 정책 백업
clish -c "add backup local"

# 3. HA 환경이면 Failover 수행
#    → Standby 노드에서 먼저 SIC Reset
clish -c "set cluster member admin down"   # 해당 노드를 Standby로 전환

# 4. SIC Reset 실행 (위 절차)

# 5. SmartConsole에서 Trust 재수립 (위 절차)

# 6. Policy Install 재수행
#    SmartConsole → Install Policy → 해당 Gateway 선택

# 7. 정상 동작 확인
cpstat fw              # Firewall 상태
cpstat mg              # Management 연결 상태 (해당 시)
fw ctl pstat           # 정책 적용 상태

# 8. HA 환경이면 Active로 복귀 후, 나머지 노드도 동일 작업
```

---

### 면접관: "Management Server 자체를 교체해야 하는 상황이 생겼습니다. 새 Management에서 기존 Gateway들과 SIC를 다시 맺어야 하는데, 어떻게 진행합니까?"

Management Server 교체는 **새로운 CA가 생성**되므로, 기존 모든 Gateway와의 SIC를 재수립해야 하는 대규모 작업입니다.

#### 시나리오별 접근

**시나리오 A: Management 백업으로 복원 가능한 경우 (권장)**

```
# 기존 Management의 백업에 ICA(Internal CA) 정보가 포함됨
# 새 Management에 동일한 버전의 GAiA OS 설치 후:

# 1. 새 Management FTW 완료
# 2. 백업 파일 복원
migrate import <backup_file>

# 이 경우 기존 CA 인증서가 복원되므로
# Gateway들의 SIC 재설정 불필요!
# → Policy Install만 재수행하면 됨
```

**시나리오 B: 백업 없이 완전 새로 구축하는 경우**

```
# 1. 새 Management Server FTW 완료 (새 ICA 자동 생성)

# 2. SmartConsole에서 모든 Gateway Object 재생성
#    - Gateway IP, 이름, 인터페이스 정보 입력
#    - Activation Key 설정

# 3. 각 Gateway에서 SIC Reset 수행
#    (모든 Gateway에 SSH 접속하여 개별 작업)
expert
cpconfig
# → SIC Reset → 새 Activation Key 입력
cpstop && cpstart

# 4. SmartConsole에서 각 Gateway의 Communication → Initialize

# 5. Get Topology: 각 Gateway Object에서 "Get Interfaces" 실행
#    → 인터페이스, 토폴로지 자동 인식

# 6. Security Policy 재작성 (또는 기존 정책 내보내기/가져오기)

# 7. Policy Install

# ※ Gateway가 많을수록 작업 시간이 길어지므로
#    반드시 유지보수 시간 확보
```

#### Management 백업/복원 명령어

```
# Management Server 백업 (Expert Mode)
# 방법 1: 내장 백업
backup

# 방법 2: migrate export (정책 + 오브젝트 + 인증서 포함)
migrate export <filename>
# → $FWDIR/bin/upgrade_tools/ 경로에 생성

# 방법 3: 스냅샷 (전체 시스템 이미지)
clish -c "add snapshot sp_<date>"

# 새 Management에서 복원
migrate import <filename>

# 복원 후 확인
cpwd_admin list          # 모든 데몬 정상 기동
cpstat mg                # Management 상태
```

---

### 면접관: "SIC 인증서의 유효기간이 만료되면 어떻게 됩니까? 사전에 관리하는 방법이 있나요?"

SIC 인증서는 기본적으로 **ICA(Internal CA)가 발급**하며, 유효기간이 있습니다. R80.x 이상에서는 기본 5년이지만, 버전에 따라 다를 수 있습니다.

#### 인증서 만료 시 영향

- Management ↔ Gateway 간 SIC 통신 실패
- Policy Install 불가
- 로그 전송 중단
- SmartConsole에서 Gateway 상태 비정상 표시

#### 인증서 만료 확인

```
# Management Server Expert Mode에서 ICA 인증서 목록 확인
cpca_client lscert -kind SIC

# 출력 예시:
# Serial: 1234
# Subject: CN=cp_gw1,O=myorg...
# Not Before: Jan 1 2022
# Not After: Jan 1 2027     ← 만료 일자
# Status: Valid

# SmartConsole에서 확인:
# Menu → Manage & Settings → Certificate Authority
# → Internal CA 인증서 정보 및 발급된 인증서 목록 확인

# 특정 Gateway의 인증서 만료일 확인
cpca_client lscert -kind SIC -dn "cn=cp_gw1,o=myorg"
```

#### 인증서 갱신 (Renewal)

```
# R81.10 이상에서는 자동 갱신 기능 지원:
# SmartConsole → Global Properties → Advanced →
# Certificate Authority → "Auto-renew certificates" 확인

# 수동 갱신이 필요한 경우:
# 1. SmartConsole에서 Gateway Object → Communication
# 2. "Reset" → "Initialize" 재수행
#    → 새 인증서 발급됨

# 또는 cpca_client로 갱신:
cpca_client renewal -kind SIC -dn "cn=cp_gw1,o=myorg"
```

#### ICA 자체 만료 관리

```
# ICA(Internal CA) 인증서도 만료 기한이 있음
# ICA가 만료되면 모든 SIC 인증서가 무효화됨 → 전체 통신 중단

# ICA 만료일 확인
cpca_client lscert -kind ICA

# ICA 갱신 (중요 작업 - 서비스 영향 있음)
# Check Point sk 문서 참조 (sk38715 등)
# → 갱신 후 모든 Gateway에 Policy Install 필요

# 사전 모니터링:
# Management Server의 SmartConsole에서 System Alert으로 인증서 만료 경고 설정 가능
# → 만료 30일 전 알림 등
```

**실무 Best Practice:**
- 분기별로 인증서 만료일 점검 스케줄링
- ICA 갱신은 전체 인프라에 영향이 크므로, 사전 계획 수립 필수
- Management 백업 시 ICA 인증서 포함 여부 반드시 확인 (`migrate export` 사용 권장)
- 인증서 만료 알림을 SNMP 또는 Syslog로 모니터링 시스템에 연동
