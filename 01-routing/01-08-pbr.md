# 01-08. PBR (Policy-Based Routing)

## 면접관: "고객사에서 '영업부서 트래픽만 별도 WAN 회선(전용선)으로 보내고, 나머지 부서는 기존 인터넷 VPN 회선을 사용하게 해달라'고 요청합니다. 어떻게 설계하시겠어요?"

일반적인 라우팅(Destination-based Routing)은 목적지 IP만 보고 경로를 결정합니다. 하지만 이 요구사항은 **출발지(영업부서 서브넷)**에 따라 다른 경로로 보내야 하므로, **PBR (Policy-Based Routing)**이 필요합니다.

**설계 방향:**
- 영업부서 서브넷(10.10.10.0/24)에서 오는 트래픽 → 전용선(WAN1) Next-hop으로 전달
- 나머지 부서 → 기존 VPN(WAN2) Next-hop으로 전달 (일반 라우팅)
- 전용선 장애 시 → 영업부서도 VPN 회선으로 Failover

```
[영업부서 10.10.10.0/24] ──┐
                            ├── [Core Router] ─── WAN1 (전용선) → ISP-A
[기타부서 10.20.20.0/24] ──┘                 └── WAN2 (VPN)    → ISP-B
```

> 토폴로지 이미지 추가 예정

### 핵심 설정

```
! 영업부서 트래픽 식별
ip access-list extended SALES-TRAFFIC
 permit ip 10.10.10.0 0.0.0.255 any
!
! PBR Route-map 정의
route-map PBR-SALES permit 10
 match ip address SALES-TRAFFIC
 set ip next-hop 172.16.1.1          ! WAN1 (전용선) Next-hop
!
route-map PBR-SALES permit 20
 ! 매칭되지 않은 트래픽은 일반 라우팅 테이블 따름
!
! 인터페이스에 PBR 적용
interface GigabitEthernet0/0
 description LAN-SIDE
 ip address 10.0.0.1 255.255.255.0
 ip policy route-map PBR-SALES
```

**중요:** PBR은 **인입(Ingress) 인터페이스**에 적용합니다. 트래픽이 들어오는 인터페이스에서 정책을 평가하고, 매칭되면 라우팅 테이블을 무시하고 지정된 Next-hop으로 전달합니다.

---

## 면접관: "PBR과 일반 라우팅(Destination-based Routing)의 차이를 정확히 설명해주세요. 패킷 처리 순서에서 PBR은 어디에 위치하나요?"

**패킷 처리 순서:**

```
패킷 인입
  ↓
1. Input ACL 검사
  ↓
2. ★ PBR 검사 (ip policy route-map)
  ↓
3. Routing Table Lookup (CEF/FIB)
  ↓
4. Output ACL 검사
  ↓
패킷 전달
```

**핵심 차이:**

| 항목 | Destination-based Routing | PBR |
|------|--------------------------|-----|
| 판단 기준 | 목적지 IP만 | 출발지 IP, 목적지, 프로토콜, 포트, ToS 등 |
| 처리 위치 | Routing Table (FIB) | Route-map (FIB 전에 평가) |
| 성능 | 하드웨어 기반 (CEF) | 소프트웨어 기반 (일부 플랫폼은 HW 지원) |
| 확장성 | 높음 | 정책이 많아지면 성능 저하 가능 |
| 설정 위치 | router 프로세스, static route | 인터페이스 (ingress) |

**PBR의 Match 가능 항목:**
```
route-map PBR permit 10
 match ip address <ACL>           ! 출발지/목적지 IP, 프로토콜, 포트
 match length <min> <max>         ! 패킷 크기
 !
 set ip next-hop <ip>             ! Next-hop 지정
 set ip default next-hop <ip>     ! 라우팅 테이블에 없을 때만 적용
 set interface <if>               ! 출력 인터페이스 지정
 set ip default interface <if>    ! 라우팅 테이블에 없을 때만 적용
 set ip precedence <value>        ! QoS 마킹
 set ip tos <value>               ! ToS 필드 변경
```

**set ip next-hop vs set ip default next-hop 차이:**
- `set ip next-hop`: 라우팅 테이블 무시, **무조건** 지정 Next-hop으로 전송
- `set ip default next-hop`: 라우팅 테이블에 매칭 경로가 **없을 때만** 지정 Next-hop 사용

---

## 면접관: "PBR을 설정했는데, 고객사에서 '전용선이 다운되면 영업부서 인터넷이 아예 안 된다'고 합니다. Failover가 안 되는 거죠. 왜 그렇고, 어떻게 해결하시겠어요?"

PBR은 기본적으로 **Next-hop의 상태를 확인하지 않습니다.** `set ip next-hop 172.16.1.1`로 설정하면, 172.16.1.1이 다운되어도 계속 그쪽으로 패킷을 보내려고 시도합니다. 연결된 인터페이스가 물리적으로 DOWN이면 PBR이 무시되고 일반 라우팅을 따르지만, 인터페이스는 UP인데 **원격지(Next-hop)가 다운**인 경우에는 블랙홀이 발생합니다.

**해결: IP SLA + PBR Tracking**

IP SLA로 Next-hop의 실제 도달 가능성을 주기적으로 모니터링하고, PBR에 tracking을 연동합니다.

### 핵심 설정

```
! IP SLA 정의: WAN1 Next-hop에 ICMP 모니터링
ip sla 1
 icmp-echo 172.16.1.1 source-ip 172.16.1.2
 frequency 5
 timeout 2000
 threshold 1000
!
ip sla schedule 1 life forever start-time now
!
! Tracking Object 정의
track 1 ip sla 1 reachability
 delay down 10 up 30
!
! PBR에 Tracking 연동
route-map PBR-SALES permit 10
 match ip address SALES-TRAFFIC
 set ip next-hop verify-availability 172.16.1.1 10 track 1
!
route-map PBR-SALES permit 20
 ! Tracking 실패 시 → 일반 라우팅 테이블 따름 (VPN 회선)
```

**동작 흐름:**
1. IP SLA가 5초마다 172.16.1.1에 ICMP Echo 전송
2. 응답이 오면 Track 1 = UP → PBR 정상 동작 (WAN1으로 전달)
3. 응답이 없으면 10초 후 Track 1 = DOWN → PBR의 set 무시 → 일반 라우팅 (WAN2)
4. 응답이 복구되면 30초 후 Track 1 = UP → PBR 다시 동작 (WAN1 복귀)

**delay down/up 설정 이유:**
- `delay down 10`: 순간 패킷 유실로 불필요한 전환 방지 (10초 연속 실패 후 DOWN)
- `delay up 30`: 불안정한 복구에서 반복 전환(Flapping) 방지 (30초 연속 성공 후 UP)

**확인 명령어:**
```
show ip sla statistics 1
show track 1
show route-map PBR-SALES
show ip policy
!
! 디버깅
debug ip policy
```

---

## 면접관: "IP SLA에서 ICMP만 쓸 수 있나요? 다른 모니터링 방법은 뭐가 있죠?"

IP SLA는 다양한 프로토콜을 지원합니다:

| Type | 용도 | 특징 |
|------|------|------|
| `icmp-echo` | 기본 Ping | 가장 간단, 대부분의 장비에서 지원 |
| `tcp-connect` | TCP 포트 연결 테스트 | 특정 서비스 가용성 확인 (웹서버 80, DB 3306) |
| `http` | HTTP GET 응답 확인 | 웹 서비스 레벨 모니터링 |
| `dns` | DNS 쿼리 응답 확인 | DNS 서비스 가용성 |
| `udp-echo` | UDP Echo 테스트 | 상대측에 IP SLA Responder 필요 |
| `udp-jitter` | Jitter, Latency, Packet Loss 측정 | VoIP 품질 모니터링에 주로 사용 |
| `path-echo` | Traceroute + Echo | 경로상의 각 홉 상태 확인 |

```
! TCP Connect 예시: 웹 서버 포트 443 확인
ip sla 2
 tcp-connect 172.16.1.10 443 source-ip 172.16.1.2
 frequency 10
!
! HTTP GET 예시
ip sla 3
 http get http://172.16.1.10/health
 frequency 30
!
! UDP Jitter 예시 (VoIP 모니터링)
ip sla 4
 udp-jitter 172.16.1.1 16384 source-ip 172.16.1.2
 frequency 60
```

**실무 권장:**
- 단순 회선 상태 확인: `icmp-echo`
- 특정 서비스 가용성: `tcp-connect`
- ICMP가 차단된 환경: `tcp-connect` 또는 상대측에 IP SLA Responder 설정
- VoIP 품질 보장: `udp-jitter`

```
! IP SLA Responder (상대측 라우터에 설정)
ip sla responder
!
! 상세 통계 확인
show ip sla statistics 1 detail
show ip sla configuration 1
```

---

## 면접관: "영업부서뿐 아니라 '화상회의 트래픽은 전용선, 파일 다운로드는 VPN 회선'이라는 추가 요구사항이 왔습니다. 포트 기반으로 PBR을 분류할 수 있나요?"

가능합니다. Extended ACL을 사용하면 프로토콜, 포트 기반으로 트래픽을 분류할 수 있습니다.

```
! 화상회의 트래픽 식별 (Webex, Zoom, Teams 등)
ip access-list extended VIDEO-CONFERENCE
 permit udp any any range 9000 9999            ! RTP 미디어
 permit udp any any eq 3478                    ! STUN/TURN
 permit tcp any any eq 443                     ! HTTPS (시그널링)
 remark --- Specific SaaS IP ranges ---
 permit ip any 170.114.0.0 0.0.255.255         ! Zoom
 permit ip any 13.107.0.0 0.0.255.255          ! Teams
!
! 대용량 파일 다운로드 식별
ip access-list extended BULK-DOWNLOAD
 permit tcp any any eq 21                       ! FTP
 permit tcp any any eq 445                      ! SMB
 permit tcp any any range 8080 8089             ! 파일 서버
!
! PBR Route-map
route-map PBR-APP permit 10
 match ip address VIDEO-CONFERENCE
 set ip next-hop verify-availability 172.16.1.1 10 track 1     ! WAN1 (전용선)
!
route-map PBR-APP permit 20
 match ip address BULK-DOWNLOAD
 set ip next-hop verify-availability 172.16.2.1 20 track 2     ! WAN2 (VPN)
!
route-map PBR-APP permit 30
 ! 나머지 → 일반 라우팅
!
interface GigabitEthernet0/0
 ip policy route-map PBR-APP
```

**주의사항:**
- HTTPS(443)로 모든 서비스가 암호화되는 요즘, 포트만으로는 애플리케이션을 정확히 구분하기 어려움
- 목적지 IP 대역으로 분류하는 것이 더 정확 (SaaS 서비스의 공개 IP 대역 활용)
- ACL이 복잡해질수록 성능 영향 고려 필요

---

## 면접관: "PBR의 한계점은 뭐가 있다고 생각하세요? 더 나은 대안이 있나요?"

PBR에는 명확한 한계가 있고, 현대 네트워크에서는 더 나은 대안들이 존재합니다.

**PBR의 한계:**

**1. 성능 문제**
- 전통적으로 소프트웨어(Process Switching)에서 처리
- 최신 플랫폼(Catalyst 9000, Nexus 등)은 하드웨어 PBR 지원하지만, ACL이 복잡하면 TCAM 자원 소모
- 대량 트래픽에서 성능 저하 가능

**2. 확장성 문제**
- 정책이 많아질수록 Route-map/ACL 관리가 복잡해짐
- 사이트마다 개별 설정 필요 (중앙 관리 어려움)
- 변경 시 모든 라우터에 수동 반영

**3. 가시성 부족**
- 트래픽이 PBR을 타고 있는지 확인이 어려움
- `debug ip policy`는 운영 환경에서 부하가 큼
- 정책별 트래픽 통계가 제한적

**4. 애플리케이션 인식 한계**
- L3/L4(IP/포트)까지만 분류 가능
- HTTPS 암호화 트래픽 내 애플리케이션 구분 불가
- DPI(Deep Packet Inspection) 불가

**대안 기술들:**

**1. SD-WAN (Software-Defined WAN)**
```
가장 현대적인 대안. PBR의 모든 한계를 해결:
- 중앙 컨트롤러에서 정책 일괄 관리/배포
- Application-aware Routing (DPI 기반)
- 실시간 회선 품질 모니터링 + 자동 경로 전환
- SLA 기반 경로 선택 (Latency, Jitter, Packet Loss)
- Zero-touch Provisioning
```

**2. DMVPN + Performance Routing (PfR)**
```
Cisco 전용 솔루션:
- DMVPN으로 다중 WAN 터널 구성
- PfR이 실시간 네트워크 성능 측정
- 성능 기반으로 자동 경로 전환
- PBR보다 지능적이지만 설정 복잡
```

**3. QoS + ECMP**
```
트래픽 분리가 아닌 우선순위 부여 방식:
- 모든 WAN 회선을 ECMP로 부하분산
- QoS로 중요 트래픽 우선 처리
- 특정 회선으로 강제 전달하지 않지만, 품질 보장
```

---

## 면접관: "마지막으로, 라우터 자체에서 생성하는 트래픽(관리 트래픽 등)에 PBR을 적용하려면 어떻게 하죠? 일반 PBR과 뭐가 다른가요?"

**Local PBR (로컬 정책 라우팅)**이 필요합니다.

일반 PBR은 **Transit 트래픽** (라우터를 통과하는 트래픽)에만 적용됩니다. 라우터 자체에서 생성하는 트래픽(Ping, SSH, SNMP Trap, Syslog 등)은 일반 PBR이 적용되지 않습니다.

```
! 일반 PBR: 인터페이스에 적용 (Transit 트래픽)
interface GigabitEthernet0/0
 ip policy route-map PBR-TRANSIT

! Local PBR: 글로벌에 적용 (라우터 자체 생성 트래픽)
ip local policy route-map PBR-LOCAL
```

**실무 활용 예시: 관리 트래픽을 관리용 WAN으로 전송**

```
! 관리 서버 대역 식별
ip access-list extended MGMT-TRAFFIC
 permit ip any host 192.168.100.10    ! Syslog 서버
 permit ip any host 192.168.100.20    ! SNMP 서버
 permit ip any host 192.168.100.30    ! NTP 서버
!
route-map PBR-LOCAL permit 10
 match ip address MGMT-TRAFFIC
 set ip next-hop 172.16.100.1         ! 관리용 WAN Gateway
!
route-map PBR-LOCAL permit 20
 ! 나머지는 일반 라우팅
!
ip local policy route-map PBR-LOCAL
```

**주의사항:**
- Local PBR도 IP SLA Tracking과 연동 가능
- 하지만 Local PBR은 **항상 Process Switching**되므로 성능 영향이 있음
- 관리 트래픽은 양이 적으므로 큰 문제는 아니지만, 데이터 트래픽에 Local PBR을 남용하면 안 됨

**확인 명령어:**
```
show ip local policy
show route-map PBR-LOCAL
!
! PBR 매칭 통계 확인
show route-map PBR-SALES
  route-map PBR-SALES, permit, sequence 10
    Match clauses:
      ip address (access-lists): SALES-TRAFFIC
    Set clauses:
      ip next-hop verify-availability 172.16.1.1 10 track 1
    Policy routing matches: 15432 packets, 8234567 bytes   ← 매칭 통계
!
! 특정 패킷이 PBR을 타는지 테스트
debug ip policy
! 또는 (운영 환경 권장)
show ip cef exact-route <src> <dst>    ! CEF 기반 경로 확인
```

**PBR 설계 원칙 정리:**

1. **최소한으로 사용:** PBR은 일반 라우팅으로 해결 안 되는 경우에만 적용
2. **반드시 Tracking 연동:** Next-hop 장애 시 블랙홀 방지
3. **Permit 20 (빈 sequence) 필수:** 매칭 안 되는 트래픽이 일반 라우팅을 따르도록
4. **문서화:** 어떤 트래픽이 어떤 경로를 타는지 명확히 기록
5. **모니터링:** `show route-map` 통계로 정상 동작 확인
6. **장기적 대안 검토:** SD-WAN 등 현대적 솔루션으로 대체 계획 수립
