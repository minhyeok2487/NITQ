# 01-07. VRF (Virtual Routing and Forwarding)

## 면접관: "고객사가 본사 건물 하나에 영업부서와 개발부서가 있는데, '두 부서의 네트워크를 완전히 분리해달라, 서로 절대 통신되면 안 된다'고 요청합니다. 물리적으로 장비를 따로 두긴 비용이 부담되고요. 어떻게 설계하시겠어요?"

물리적 분리 없이 논리적으로 네트워크를 완전히 격리하는 방법이 **VRF (Virtual Routing and Forwarding)**입니다. 하나의 물리 라우터 안에 여러 개의 독립된 라우팅 테이블을 만드는 기술입니다.

**설계 방향: VRF-Lite**
- VRF `SALES`: 영업부서 전용 라우팅 테이블
- VRF `DEV`: 개발부서 전용 라우팅 테이블
- Global Routing Table: 인터넷, 공용 서비스
- 각 VRF는 독립적인 라우팅 테이블, ARP 테이블을 가짐
- 동일 IP 대역을 양쪽에서 사용해도 충돌 없음 (겹치는 주소 공간 가능)

**물리적 구성:**
- 코어 라우터에서 VLAN Trunk로 스위치와 연결
- 스위치에서 부서별 VLAN 할당
- 라우터의 Sub-interface를 각 VRF에 매핑

> 토폴로지 이미지 추가 예정

### 핵심 설정

```
! VRF 정의
ip vrf SALES
 description Sales-Department-Network
!
ip vrf DEV
 description Development-Department-Network
!
! 인터페이스를 VRF에 할당
interface GigabitEthernet0/0.10
 description SALES-VLAN10
 encapsulation dot1Q 10
 ip vrf forwarding SALES
 ip address 10.10.10.1 255.255.255.0
!
interface GigabitEthernet0/0.20
 description DEV-VLAN20
 encapsulation dot1Q 20
 ip vrf forwarding DEV
 ip address 10.20.20.1 255.255.255.0
!
! 각 VRF별 라우팅 (예: Static Route)
ip route vrf SALES 0.0.0.0 0.0.0.0 10.10.10.254
ip route vrf DEV 0.0.0.0 0.0.0.0 10.20.20.254
!
! VRF별 OSPF 인스턴스 (동적 라우팅이 필요한 경우)
router ospf 10 vrf SALES
 router-id 10.10.10.1
 network 10.10.0.0 0.0.255.255 area 0
!
router ospf 20 vrf DEV
 router-id 10.20.20.1
 network 10.20.0.0 0.0.255.255 area 0
```

**중요 주의사항:**
인터페이스에 `ip vrf forwarding` 명령을 적용하면, 기존 IP 주소가 **자동으로 제거**됩니다. 반드시 VRF 할당 후에 IP 주소를 재설정해야 합니다.

```
! 잘못된 순서 (IP 주소가 사라짐)
interface Gi0/0.10
 ip address 10.10.10.1 255.255.255.0
 ip vrf forwarding SALES           ← 이 시점에 IP가 제거됨!

! 올바른 순서
interface Gi0/0.10
 ip vrf forwarding SALES           ← 먼저 VRF 할당
 ip address 10.10.10.1 255.255.255.0   ← 그 다음 IP 설정
```

---

## 면접관: "VRF에서 RD(Route Distinguisher)와 RT(Route Target)라는 개념이 있는데, 차이가 뭔가요? VRF-Lite에서도 쓰나요?"

이것은 VRF를 이해하는 데 가장 중요한 개념입니다.

**RD (Route Distinguisher):**
- **목적:** 서로 다른 VRF에서 동일한 IP prefix를 구분하기 위한 **식별자**
- **형식:** 8바이트, 보통 `ASN:nn` 또는 `IP:nn` 형태 (예: 65001:10)
- **동작:** IPv4 prefix 앞에 RD를 붙여 **VPNv4 prefix**를 만듦
  - VRF SALES: 10.0.0.0/8 → **65001:10**:10.0.0.0/8
  - VRF DEV: 10.0.0.0/8 → **65001:20**:10.0.0.0/8
  - 이제 BGP에서 두 경로를 구분할 수 있음
- **범위:** 경로 식별 용도. 경로가 어디로 전파되는지와는 무관

**RT (Route Target):**
- **목적:** VRF 간 경로를 **Import/Export**하는 정책 제어
- **형식:** Extended Community Attribute (예: 65001:10)
- **동작:**
  - Export RT: "이 VRF의 경로를 내보낼 때 이 태그를 붙여라"
  - Import RT: "이 태그가 붙은 경로를 이 VRF로 가져와라"
- **핵심:** RT가 경로의 실제 전파 방향을 결정

```
RD = 여권 번호 (개인 식별)
RT = 비자 (어느 나라에 입국 가능한지)
```

**VRF-Lite vs Full VRF (VRF with RD/RT):**

| 항목 | VRF-Lite | Full VRF (with RD/RT) |
|------|---------|----------------------|
| RD 설정 | 불필요 | 필수 |
| RT 설정 | 불필요 | 필수 |
| MPLS | 불필요 | MPLS VPN과 함께 사용 |
| 용도 | 단일 라우터/사이트 분리 | 멀티사이트 VPN, PE 라우터 |
| 명령어 | `ip vrf NAME` | `vrf definition NAME` + `rd` + `route-target` |

```
! Full VRF 설정 (IOS-XE 스타일)
vrf definition SALES
 rd 65001:10
 address-family ipv4
  route-target export 65001:10
  route-target import 65001:10
 exit-address-family
!
vrf definition DEV
 rd 65001:20
 address-family ipv4
  route-target export 65001:20
  route-target import 65001:20
 exit-address-family
```

---

## 면접관: "잘 설명하셨습니다. 그런데 고객사에서 추가 요구가 왔어요. '영업부서와 개발부서는 완전 분리하되, 본사에 있는 공용 파일 서버(10.100.1.10)만큼은 양쪽 부서에서 모두 접근 가능하게 해달라'고 합니다. 어떻게 하시겠어요?"

이것은 **Route Leaking (Inter-VRF Routing)**입니다. VRF 간에 특정 경로만 선택적으로 공유하는 기법입니다.

**방법 1: Static Route Leaking (가장 간단)**
```
! 공용 서버가 Global Routing Table에 있는 경우
!
! SALES VRF에서 공용 서버로 가는 경로 추가
ip route vrf SALES 10.100.1.10 255.255.255.255 GigabitEthernet0/0.100 10.100.1.1 global
!
! DEV VRF에서 공용 서버로 가는 경로 추가
ip route vrf DEV 10.100.1.10 255.255.255.255 GigabitEthernet0/0.100 10.100.1.1 global
!
! 공용 서버에서 각 VRF로 돌아오는 리턴 경로
ip route 10.10.10.0 255.255.255.0 GigabitEthernet0/0.10 10.10.10.1
ip route 10.20.20.0 255.255.255.0 GigabitEthernet0/0.20 10.20.20.1
```

**방법 2: Route Target Import/Export (Full VRF)**
```
! 공용 서버를 SHARED VRF에 배치
vrf definition SHARED
 rd 65001:100
 address-family ipv4
  route-target export 65001:100
  route-target import 65001:100
  route-target import 65001:10     ! SALES 경로도 수신
  route-target import 65001:20     ! DEV 경로도 수신
 exit-address-family
!
! SALES VRF에서 SHARED 경로 수신
vrf definition SALES
 rd 65001:10
 address-family ipv4
  route-target export 65001:10
  route-target import 65001:10
  route-target import 65001:100    ! SHARED 경로 수신
 exit-address-family
!
! DEV VRF에서 SHARED 경로 수신
vrf definition DEV
 rd 65001:20
 address-family ipv4
  route-target export 65001:20
  route-target import 65001:20
  route-target import 65001:100    ! SHARED 경로 수신
 exit-address-family
```

**방법 3: MP-BGP를 이용한 Route Leaking (가장 정교)**
```
router bgp 65001
 address-family ipv4 vrf SALES
  redistribute connected
 exit-address-family
 !
 address-family ipv4 vrf DEV
  redistribute connected
 exit-address-family
 !
 address-family ipv4 vrf SHARED
  redistribute connected
 exit-address-family
```

RT Import/Export에 의해 BGP가 자동으로 VRF 간 경로를 교환합니다.

**보안 주의사항:**
Route Leaking을 하면 경로는 공유되지만, **ACL이나 방화벽으로 실제 허용 트래픽을 제한**해야 합니다. 그렇지 않으면 SALES↔DEV 간 공용 서버를 경유한 우회 통신이 가능해질 수 있습니다.

```
! SHARED VRF 인터페이스에서 ACL로 제한
ip access-list extended SHARED-ACCESS
 permit ip 10.10.10.0 0.0.0.255 host 10.100.1.10    ! SALES → 서버
 permit ip 10.20.20.0 0.0.0.255 host 10.100.1.10    ! DEV → 서버
 permit ip host 10.100.1.10 10.10.10.0 0.0.0.255    ! 서버 → SALES
 permit ip host 10.100.1.10 10.20.20.0 0.0.0.255    ! 서버 → DEV
 deny   ip 10.10.10.0 0.0.0.255 10.20.20.0 0.0.0.255   ! SALES↔DEV 차단
 deny   ip 10.20.20.0 0.0.0.255 10.10.10.0 0.0.0.255   ! DEV↔SALES 차단
```

---

## 면접관: "Route Leaking을 설정했는데, 고객사에서 '개발부서에서 공용 서버 접속이 안 된다'고 합니다. 어디부터 확인하죠?"

**1단계: VRF별 라우팅 테이블 확인**
```
show ip route vrf DEV
show ip route vrf DEV 10.100.1.10
```
DEV VRF에 공용 서버(10.100.1.10)로의 경로가 있는지 확인. 없으면 Route Leaking 설정 문제.

**2단계: VRF에서 Ping 테스트**
```
ping vrf DEV 10.100.1.10 source 10.20.20.1
```
VRF를 지정하지 않으면 Global Routing Table에서 Ping을 보내므로, 반드시 `vrf` 옵션 사용.

**3단계: 리턴 경로 확인**
```
! 공용 서버 측(Global 또는 SHARED VRF)에서 DEV 네트워크로의 경로 확인
show ip route 10.20.20.0
! 또는
show ip route vrf SHARED 10.20.20.0
```
가장 흔한 원인: **리턴 경로 누락**. VRF에서 서버로 가는 경로는 있지만, 서버에서 VRF 네트워크로 돌아오는 경로가 없는 경우.

**4단계: ARP 테이블 확인**
```
show ip arp vrf DEV
show ip arp vrf SHARED
```
VRF가 다르면 ARP도 분리되어 있으므로, 각 VRF의 ARP 테이블을 별도로 확인해야 합니다.

**5단계: ACL 확인**
```
show ip access-lists SHARED-ACCESS
! Hit count 확인 → deny에 매칭되고 있는지
```

**6단계: CEF 확인**
```
show ip cef vrf DEV 10.100.1.10
show ip cef vrf SHARED 10.20.20.0
```
CEF 테이블에서 실제 Forwarding 경로가 정상인지 확인.

---

## 면접관: "고객사 규모가 커져서, 본사뿐 아니라 지사에도 동일한 VRF 분리가 필요합니다. 지사까지 VRF를 확장하려면 어떻게 하죠?"

여기서 **VRF-Lite의 한계**와 **MPLS VPN**의 필요성이 나옵니다.

**VRF-Lite의 한계:**
- 라우터 간 VRF를 연결하려면, 각 VRF마다 **별도의 물리/논리 링크**가 필요
- 본사-지사 간 WAN 링크에서 VRF가 3개면 → Sub-interface 3개 필요
- VRF가 늘어날수록 WAN 구간 설정이 복잡해지고, 링크 자원 낭비

```
! VRF-Lite: VRF마다 별도 Sub-interface 필요
interface GigabitEthernet0/1.10
 ip vrf forwarding SALES
 ip address 172.16.1.1 255.255.255.252
!
interface GigabitEthernet0/1.20
 ip vrf forwarding DEV
 ip address 172.16.2.1 255.255.255.252
!
interface GigabitEthernet0/1.100
 ip vrf forwarding SHARED
 ip address 172.16.3.1 255.255.255.252
```

**MPLS L3VPN 아키텍처:**

MPLS VPN은 Provider Edge(PE) 라우터에서 VRF를 관리하고, Provider(P) 라우터는 MPLS Label Switching만 수행합니다. VRF 경로는 **MP-BGP VPNv4**로 PE 간에 교환됩니다.

```
[CE] --- [PE] === MPLS Core === [PE] --- [CE]
         VRF                    VRF
```

- **CE (Customer Edge):** 고객 라우터. VRF 모름. 일반 라우팅 프로토콜 사용
- **PE (Provider Edge):** VRF 관리, CE와 라우팅 프로토콜 연동, MP-BGP로 VPNv4 교환
- **P (Provider):** MPLS Label Switching만. VRF/고객 경로 모름

**PE 라우터 핵심 설정:**
```
! VRF 정의
vrf definition SALES
 rd 65001:10
 address-family ipv4
  route-target export 65001:10
  route-target import 65001:10
 exit-address-family
!
! CE 연결 인터페이스
interface GigabitEthernet0/0
 vrf forwarding SALES
 ip address 192.168.1.1 255.255.255.252
!
! CE와 라우팅 (OSPF, EIGRP, eBGP, Static 중 선택)
router ospf 10 vrf SALES
 redistribute bgp 65001 subnets
 network 192.168.1.0 0.0.0.3 area 0
!
! PE 간 MP-BGP VPNv4
router bgp 65001
 neighbor 10.0.0.2 remote-as 65001
 neighbor 10.0.0.2 update-source Loopback0
 !
 address-family vpnv4
  neighbor 10.0.0.2 activate
  neighbor 10.0.0.2 send-community extended
 exit-address-family
 !
 address-family ipv4 vrf SALES
  redistribute ospf 10
 exit-address-family
```

**MPLS VPN의 이점:**
- PE 간 단일 링크로 수백 개 VRF 경로 전달 가능 (Label로 구분)
- VRF 추가 시 WAN 구간 변경 불필요 (PE에서 VRF 설정만 추가)
- P 라우터는 고객 경로를 전혀 모름 → 확장성, 보안

---

## 면접관: "MPLS VPN에서 RD가 같아도 되나요? 다른 사이트의 동일 고객 VRF에 같은 RD를 쓰는 것과 다른 RD를 쓰는 것의 차이가 뭔가요?"

이것은 MPLS VPN 설계에서 자주 논의되는 주제입니다.

**같은 RD를 사용하는 경우 (RD per VPN):**
```
PE-1: vrf SALES → rd 65001:10
PE-2: vrf SALES → rd 65001:10
```
- 동일 VPN의 모든 사이트에서 같은 RD 사용
- BGP Best Path Selection에서 동일 VPNv4 prefix로 취급
- **Route Reflector에서 Best Path만 반영** → 일부 경로가 손실될 수 있음
- 단순하지만 대규모에서 문제 가능

**다른 RD를 사용하는 경우 (Unique RD per PE):**
```
PE-1: vrf SALES → rd 1.1.1.1:10
PE-2: vrf SALES → rd 2.2.2.2:10
```
- 각 PE에서 고유한 RD 사용 (보통 Router-ID:VRF-ID)
- 동일 IPv4 prefix라도 RD가 다르므로 서로 다른 VPNv4 경로로 인식
- **Route Reflector가 모든 경로를 유지** → PE에서 최적 경로 선택 가능
- 대규모 환경에서 권장

**권장사항:** Cisco에서는 **Unique RD per PE (per VRF per PE)** 를 권장합니다. 특히 Route Reflector 환경에서는 동일 RD를 사용하면 best path만 반영되어 차선 경로가 손실됩니다.

```
! 확인 명령어
show bgp vpnv4 unicast all
show bgp vpnv4 unicast vrf SALES
show ip vrf detail SALES
show mpls forwarding-table vrf SALES
```

---

## 면접관: "VRF 환경에서 관리(Management) 접속은 어떻게 하나요? SSH로 장비에 접속할 때 VRF를 고려해야 하죠?"

네, VRF 환경에서는 관리 트래픽도 VRF를 인식해야 합니다.

**문제:** 관리 서버가 특정 VRF에 있거나, 관리용 VRF를 별도로 운영할 때, SSH/SNMP/Syslog 등이 올바른 VRF를 통해 나가야 합니다.

```
! 관리용 VRF 정의
vrf definition MGMT
 rd 65001:999
 address-family ipv4
 exit-address-family
!
interface GigabitEthernet0/2
 vrf forwarding MGMT
 ip address 192.168.100.1 255.255.255.0
!
! SSH를 관리 VRF로 제한
ip ssh source-interface GigabitEthernet0/2
!
! SNMP Trap을 관리 VRF에서 전송
snmp-server host 192.168.100.10 vrf MGMT version 2c community-string
!
! Syslog를 관리 VRF에서 전송
logging host 192.168.100.20 vrf MGMT
!
! NTP를 관리 VRF에서 사용
ntp server vrf MGMT 192.168.100.30
!
! TACACS+를 관리 VRF에서 사용
ip tacacs source-interface GigabitEthernet0/2
aaa group server tacacs+ MGMT-AAA
 server-private 192.168.100.40 key SecretKey
 ip vrf forwarding MGMT
!
! VRF에서 Ping/Traceroute
ping vrf MGMT 192.168.100.10
traceroute vrf MGMT 192.168.100.10
```

관리 VRF를 별도로 두는 것은 보안 모범 사례입니다. 데이터 트래픽과 관리 트래픽을 완전히 분리하여, 데이터 플레인 장애가 관리 접속에 영향을 주지 않도록 합니다.
